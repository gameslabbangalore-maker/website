<div class="title"><h2>Upcoming Events</h2></div>
<div id="events" class="cards-row" aria-live="polite"></div>
<script>
(async function(){
  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSs9vlFaLhdFNFXvWsBIXlAJu0J5Dj2deY_7SlwAGd9Jk1-djK6xP3rdXim7Co0BJ-pUJueDCYYugew/pub?gid=1356004046&single=true&output=csv";
  const fallbackImage = "https://via.placeholder.com/800x450?text=Event+Image";
  const container = document.getElementById("events");

  // skeleton helpers rely on scripts-skeletons include being loaded globally
  setSkeletons(container, 3);

  function clean(v){ if (v==null) return ""; return String(v).trim().replace(/^\"|\"$/g,''); }
  function parseEventDate(str){
    if (!str) return null;
    str = String(str).trim().replace(/^[A-Za-z]{3},?\s*/, '').replace(/’|`/g,"'");
    let m = str.match(/^(\d{1,2})\s+([A-Za-z]{3})\s+'(\d{2})$/);
    if (m){ const d=+m[1], mon={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11}[m[2]], y=2000+ +m[3]; if (mon!=null) return new Date(y,mon,d); }
    m = str.match(/^(\d{1,2})\s+([A-Za-z]{3})\s+(\d{4})$/);
    if (m){ const d=+m[1], mon={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11}[m[2]], y=+m[3]; if (mon!=null) return new Date(y,mon,d); }
    m = str.match(/^([A-Za-z]{3})\s+(\d{1,2}),\s*(\d{4})$/);
    if (m){ const mon={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11}[m[1]], d=+m[2], y=+m[3]; if (mon!=null) return new Date(y,mon,d); }
    m = str.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
    if (m) return new Date(+m[1], +m[2]-1, +m[3]);
    const d = new Date(str); return isNaN(d) ? null : d;
  }

  try{
    const res = await fetch(csvUrl + '&cb=' + Date.now(), { cache: "no-store" });
    if(!res.ok) throw new Error("CSV fetch failed: " + res.status);
    const parsed = Papa.parse(await res.text(), {skipEmptyLines:true});
    const rows = (parsed.data||[]).slice(1).filter(r => r && r[0] && String(r[0]).trim() !== "");
    const today = new Date(); today.setHours(0,0,0,0);

    const items = [];
    rows.sort((a,b)=>{
      const da = parseEventDate(clean(a[1]));
      const db = parseEventDate(clean(b[1]));
      if(!da) return 1; if(!db) return -1; return da - db;
    }).forEach(cols=>{
      const dateObj = parseEventDate(clean(cols[1]));
      if(!dateObj) return;
      dateObj.setHours(0,0,0,0);
      if(dateObj < today) return;
      items.push(cols);
    });

    if (items.length > 0) setSkeletons(container, items.length);

    items.forEach((cols, idx)=>{
      const name = clean(cols[0]);
      const date = clean(cols[1]);
      const time = clean(cols[2]);
      const locText = clean(cols[3]);
      const pageLink = clean(cols[4]);
      const image = clean(cols[8]) || fallbackImage;
      const eventDateObj = parseEventDate(date);

      const card = document.createElement("article");
      card.className = "card";

      const media = document.createElement("div");
      media.className = "media";
      const img = document.createElement("img");
      img.loading = "lazy"; img.src = image; img.alt = name || "Event image";
      img.width = 800; img.height = 450;
      img.onerror = function(){ this.onerror=null; this.src = fallbackImage; };
      media.appendChild(img);
      card.appendChild(media);

      const body = document.createElement("div");
      body.className = "card-body";

      const h = document.createElement("h3");
      h.className = "event-title";
      h.textContent = name || "Untitled Event";
      body.appendChild(h);

      const meta = document.createElement("p");
      meta.className = "meta";
      meta.textContent = (date ? date : "") + ((date && time) ? " | " : "") + (time ? time : "");
      body.appendChild(meta);

      if (locText) {
        const locP = document.createElement("p");
        locP.className = "location";
        locP.textContent = locText;
        body.appendChild(locP);
      }

      const mobileInfo = document.createElement("p");
      mobileInfo.className = "mobile-info";
      if (locText) mobileInfo.appendChild(document.createTextNode(locText));
      if (locText && time) mobileInfo.appendChild(document.createTextNode(" | "));
      if (time) mobileInfo.appendChild(document.createTextNode(time));
      body.appendChild(mobileInfo);

      card.appendChild(body);

      if (eventDateObj) {
        const dayNum = eventDateObj.getDate();
        const monthShort = eventDateObj.toLocaleString('en-US', { month: 'short' });
        const dateBox = document.createElement("div");
        dateBox.className = "card-date";
        dateBox.innerHTML =
          `<div class="day">${String(dayNum).padStart(2,'0')}</div>` +
          `<div class="month">${monthShort}</div>` +
          `<div class="time"></div>`;
        card.appendChild(dateBox);
      }

      const footer = document.createElement("div");
      footer.className = "card-footer";
      if (pageLink) {
        const btn = document.createElement("a");
        btn.className = "book-btn";
        btn.href = pageLink;
        btn.textContent = "Details";
        btn.target = "_self";
        btn.removeAttribute('rel');
        footer.appendChild(btn);
      }
      card.appendChild(footer);

      card.addEventListener('click', function(e) {
        if (e.target.closest('a,button')) return;
        if (window.innerWidth <= 768) {
          if (pageLink) window.location.href = pageLink;
        }
      });

      replaceSkeletonWithCard(container, idx, card);
    });

    if (items.length === 0) {
      container.innerHTML = '<p style="color:#bbb">No upcoming events.</p>';
    }
  } catch (err) {
    console.error('Upcoming events error:', err);
    container.innerHTML = '<p style="color:#f66">Could not load events — check the CSV publish link and CSP settings.</p>';
  }
})();
</script>
