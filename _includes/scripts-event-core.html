<script>
(async function(){
  const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSs9vlFaLhdFNFXvWsBIXlAJu0J5Dj2deY_7SlwAGd9Jk1-djK6xP3rdXim7Co0BJ-pUJueDCYYugew/pub?gid=1356004046&single=true&output=csv";

  const BASEURL = "{{ site.baseurl | default: '' }}";
  const CLEAN = v => (v==null) ? "" : String(v).trim().replace(/^"|"$/g,'');
  const stripDomain = p => p.replace(/^https?:\/\/[^/]+/, '');
  function stripBaseAndSlash(p){
    let x = stripDomain(p);
    if (BASEURL && x.startsWith(BASEURL)) x = x.slice(BASEURL.length);
    return x.replace(/\/+$/, '');
  }

  const pagePath = stripBaseAndSlash(location.pathname || '/');
  const titleFallback = (document.getElementById('eventTitle')?.textContent || '').trim();

  function parseEventDate(str){
    if (!str) return null;
    str = str.trim().replace(/^[A-Za-z]{3},?\s*/, '').replace(/’/g,"'").replace(/`/g,"'");
    const m = str.match(/^(\d{1,2})\s+([A-Za-z]{3})\s+'(\d{2})$/);
    if (!m) return null;
    const day = parseInt(m[1],10);
    const mon = { Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11 }[m[2]];
    const year = 2000 + parseInt(m[3],10);
    return new Date(year, mon, day);
  }
  function fmtDateOnly(d){
    const dt = new Date(d);
    const wk = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dt.getDay()];
    const day = String(dt.getDate()).padStart(2,'0');
    const mon = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][dt.getMonth()];
    const yr2 = String(dt.getFullYear()).slice(-2);
    return `${wk}, ${day} ${mon} '${yr2}`;
  }
  function parseTime12h(t){
    if(!t) return {h:19,m:0};
    const m = t.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
    if(!m) return {h:19,m:0};
    let h = parseInt(m[1],10), min = parseInt(m[2],10);
    const ampm = m[3].toUpperCase();
    if (ampm==='PM' && h<12) h+=12;
    if (ampm==='AM' && h===12) h=0;
    return {h, m:min};
  }
  function makeICS({title, start, durationHours=3, locationText='', locationUrl='', description=''}){
    const dt = new Date(start);
    const end = new Date(dt.getTime() + durationHours*60*60*1000);
    const pad = n => String(n).padStart(2,'0');
    const stamp = (x)=> x.getFullYear()+pad(x.getMonth()+1)+pad(x.getDate())+'T'+pad(x.getHours())+pad(x.getMinutes())+pad(x.getSeconds());
    const loc = locationUrl ? `${locationText} (${locationUrl})` : locationText;
    const lines = [
      'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Games Lab//Events//EN','BEGIN:VEVENT',
      `DTSTAMP:${stamp(new Date())}`,`DTSTART:${stamp(dt)}`,`DTEND:${stamp(end)}`,
      `SUMMARY:${title}`,`LOCATION:${loc.replace(/,/g,'\\,')}`,`DESCRIPTION:${description}`,
      'END:VEVENT','END:VCALENDAR'
    ];
    return 'data:text/calendar;charset=utf8,' + encodeURIComponent(lines.join('\r\n'));
  }

  // Fetch sheet + find this event
  let match = null;
  try{
    const res = await fetch(SHEET_URL + '&cb=' + Date.now(), { cache:'no-store' });
    const text = await res.text();
    const rows = Papa.parse(text, { header:true, skipEmptyLines:true }).data;
    match = rows.find(r=>{
      const linkPath = stripBaseAndSlash(CLEAN(r['Page Link']));
      const name = CLEAN(r['EventName']);
      if (linkPath && pagePath.endsWith(linkPath)) return true;
      return (titleFallback && name.toLowerCase() === titleFallback.toLowerCase());
    });
  }catch(e){ console.error('Sheet load error', e); }

  // Elements
  const scHeading = document.getElementById('scheduleHeading');
  const scBlock   = document.getElementById('scheduleBlock');
  const scWhen    = document.getElementById('scWhen');
  const scWhere   = document.getElementById('scWhere');
  const scAdd     = document.getElementById('scAddCal');
  const scDir     = document.getElementById('scDir');
  const scBook    = document.getElementById('scBook');
  const fabBook   = document.getElementById('fabBook');
  const shareFab  = document.getElementById('shareFab');

  // Microbar parts
  const M = {
    bar: document.getElementById('mobileInfoBar'),
    title: document.getElementById('microTitle'),
    line1: document.getElementById('microLine1'),
    line2: document.getElementById('microLine2'),
    line3: document.getElementById('microLine3'),
    L1: document.getElementById('microLeft1'),
    L2: document.getElementById('microLeft2'),
    L3: document.getElementById('microLeft3'),
    A1: document.getElementById('microAction1'),
    A2: document.getElementById('microAction2'),
    R0: document.getElementById('microRightTitle'),
    R1: document.getElementById('microRight1'),
    R2: document.getElementById('microRight2'),
    R3: document.getElementById('microRight3'),
  };

  let scheduled = false, base = null, timeStr = '', locText = '', locLink = '', ticket = '';
  const dFormat = "{{ page.highlights.format | default: 'Social deduction' | escape }}";
  const dDuration = "{{ page.highlights.duration | default: '3–4 hours' | escape }}";
  const dGroup = "{{ page.highlights.group_size | default: '8–25 players' | escape }}";
  const dDiff = "{{ page.highlights.difficulty | default: 'Beginner-friendly' | escape }}";
  const dPrice = "{{ page.highlights.price | default: '₹ 350/-' | escape }}";

  function assignText(el, value){
    if (!el) return;
    const text = (value || '').trim();
    if (text){
      el.textContent = text;
      el.removeAttribute('hidden');
    } else {
      el.textContent = '';
      el.setAttribute('hidden','');
    }
  }

  function updateFabSpacing(){
    const docEl = document.documentElement;
    const bookVisible = fabBook && !fabBook.hasAttribute('hidden');
    let bookHeight = 0;
    if (bookVisible){
      const rect = fabBook.getBoundingClientRect();
      bookHeight = rect.height || fabBook.offsetHeight || 0;
      if (!bookHeight){ requestAnimationFrame(updateFabSpacing); return; }
    }

    let shareBottom = 12;
    if (shareFab){
      if (bookVisible){ shareBottom += Math.round(bookHeight + 8); }
      docEl.style.setProperty('--fab-share-bottom', shareBottom + 'px');
    }

    let pad = 16;
    if (bookVisible && window.innerWidth < 960){
      pad = Math.max(22, Math.round(bookHeight + 22));
    }
    docEl.style.setProperty('--mobile-bottom-pad', pad + 'px');
  }

  if (match){
    scheduled = CLEAN(match['Scheduled']).toLowerCase() === 'yes';
    const dateStr = CLEAN(match['Date']);
    timeStr = CLEAN(match['Time']);
    locText = CLEAN(match['Location']);
    locLink = CLEAN(match['Location Link']);
    ticket  = CLEAN(match['Ticket Link']);
    base = parseEventDate(dateStr);
    if (base){
      const tm = parseTime12h(timeStr);
      base.setHours(tm.h, tm.m, 0, 0);
    }
  }

  // Wire schedule (desktop) + FAB
  if (scheduled && base){
    scHeading && scHeading.removeAttribute('hidden');
    if (scBlock) scBlock.hidden = false;
    scWhen && (scWhen.textContent = fmtDateOnly(base));
    scWhere && (scWhere.textContent = locText || '');
    if (scAdd) scAdd.href = makeICS({ title: titleFallback, start: base, durationHours: 3, locationText: locText, locationUrl: locLink, description: location.href });
    if (scDir && locLink){ scDir.href = locLink; }
    if (ticket){
      scBook && (scBook.href = ticket);
      if (fabBook){
        fabBook.href = ticket;
        fabBook.removeAttribute('hidden');
      }
      requestAnimationFrame(updateFabSpacing);
    } else {
      if (fabBook){ fabBook.setAttribute('hidden', ''); }
      updateFabSpacing();
    }
  } else {
    // Not scheduled
    scHeading && scHeading.setAttribute('hidden','');
    if (scBlock) scBlock.hidden = true;
    if (fabBook){ fabBook.setAttribute('hidden',''); }
    updateFabSpacing();
  }

  // Microbar content + visibility
  if (M.title) M.title.textContent = titleFallback;
  if (scheduled && base){
    assignText(M.R0, '');
    const timePart = timeStr && timeStr.trim() ? ` | ${timeStr.trim()}` : '';
    if (M.L1){ M.L1.textContent = fmtDateOnly(base) + timePart; M.line1?.removeAttribute('hidden'); }
    assignText(M.R1, '');
    if (M.A1){
      M.A1.textContent = 'Add to Calendar';
      M.A1.href = makeICS({ title: titleFallback, start: base, durationHours: 3, locationText: locText, locationUrl: locLink, description: location.href });
      M.A1.hidden = false;
    }

    if (M.L2){ M.L2.textContent = locText || ''; }
    if (locText){
      M.line2?.removeAttribute('hidden');
    } else {
      M.line2?.setAttribute('hidden','');
    }
    assignText(M.R2, '');
    if (M.A2){
      if (locLink){
        M.A2.textContent = 'Get Directions';
        M.A2.href = locLink;
        M.A2.hidden = false;
      } else {
        M.A2.hidden = true;
        M.A2.removeAttribute('href');
      }
    }

    if (M.L3){ M.L3.textContent = ''; }
    assignText(M.R3, '');
    M.line3?.setAttribute('hidden','');
  } else {
    assignText(M.R0, dGroup);
    const hasLine1 = Boolean((dFormat || '').trim() || (dDuration || '').trim());
    if (M.line1){
      if (hasLine1){ M.line1.removeAttribute('hidden'); }
      else { M.line1.setAttribute('hidden',''); }
    }
    if (M.L1) M.L1.textContent = dFormat;
    assignText(M.R1, dDuration);
    if (M.A1){ M.A1.hidden = true; M.A1.removeAttribute('href'); }

    const hasLine2 = Boolean((dDiff || '').trim() || (dPrice || '').trim());
    if (M.line2){
      if (hasLine2){ M.line2.removeAttribute('hidden'); }
      else { M.line2.setAttribute('hidden',''); }
    }
    if (M.L2) M.L2.textContent = dDiff;
    assignText(M.R2, dPrice);
    if (M.A2){ M.A2.hidden = true; M.A2.removeAttribute('href'); }

    if (M.L3){ M.L3.textContent = ''; }
    assignText(M.R3, '');
    M.line3?.setAttribute('hidden','');
  }

  // Microbar show when scrolled past banner/title area (mobile only)
  (function(){
    const microbar = M.bar;
    const banner = document.querySelector('.banner');
    if (!microbar || !banner) return;
    function isDesktop(){ return window.innerWidth >= 960; }
    function update(){
      if (isDesktop()){ microbar.classList.remove('show'); microbar.setAttribute('aria-hidden','true'); return; }
      const topbarH = (document.querySelector('.topbar')?.offsetHeight || 56);
      const rect = banner.getBoundingClientRect();
      const bottomY = rect.bottom + window.scrollY;
      const shouldShow = window.scrollY >= (bottomY - topbarH);
      microbar.classList.toggle('show', shouldShow);
      microbar.setAttribute('aria-hidden', shouldShow ? 'false' : 'true');
    }
    window.addEventListener('load', update, { passive:true });
    window.addEventListener('scroll', update, { passive:true });
    window.addEventListener('resize', update);
    window.__updateMicrobarVis = update;
  })();

  updateFabSpacing();
  window.addEventListener('resize', ()=>{ updateFabSpacing(); });

  // Share handlers
  (function(){
    async function sharePage(){
      const data = { title: document.title, text: document.title, url: location.href };
      try{
        if (navigator.share) await navigator.share(data);
        else { await navigator.clipboard.writeText(data.url); alert('Link copied to clipboard'); }
      }catch(e){}
    }
    document.getElementById('shareBtnSide')?.addEventListener('click', sharePage);
    shareFab?.addEventListener('click', sharePage);
  })();

})();
</script>

{% include scripts-contact-phone.html %}

<!-- Video Lightbox -->
<script>
(function(){
  const modal  = document.getElementById('vidModal');
  const stage  = document.getElementById('vidStage');
  const frame  = document.getElementById('vidFrame');
  const close  = document.getElementById('vidClose');
  if (!modal || !frame || !stage) return;

  function openFrom(el){
    const url = el.getAttribute('data-embed') || el.querySelector('iframe')?.src || '';
    const withAuto = url + (url.includes('?') ? '&' : '?') + 'autoplay=1';
    if (el.classList.contains('video-portrait')) stage.classList.add('portrait'); else stage.classList.remove('portrait');
    frame.src = withAuto;
    modal.hidden = false;
  }
  function shut(){ frame.src = 'about:blank'; modal.hidden = true; }

  document.querySelectorAll('[data-embed], .video-portrait').forEach(v => {
    v.addEventListener('click', () => openFrom(v));
  });
  close.addEventListener('click', shut);
  modal.addEventListener('click', (e)=>{ if (e.target === modal) shut(); });
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !modal.hidden) shut(); });
})();
</script>
