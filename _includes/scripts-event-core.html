<script>
(function(){
  {% assign schedule_blob = site.data.event_schedule | default: {} %}
  {% assign schedule_lookup = schedule_blob.by_slug | default: {} %}
  {% assign schedule_entry = schedule_lookup[page.slug] | default: nil %}
  const scheduleData = {{ schedule_entry | jsonify }};
  const titleFallback = (document.getElementById('eventTitle')?.textContent || '').trim();

  function makeICS({ title, start, durationHours = 3, locationText = '', locationUrl = '', description = '' }){
    const dt = new Date(start);
    if (Number.isNaN(dt.getTime())) return '#';
    const end = new Date(dt.getTime() + durationHours * 60 * 60 * 1000);
    const pad = n => String(n).padStart(2,'0');
    const stamp = x => x.getUTCFullYear() + pad(x.getUTCMonth()+1) + pad(x.getUTCDate()) + 'T' + pad(x.getUTCHours()) + pad(x.getUTCMinutes()) + pad(x.getUTCSeconds()) + 'Z';
    const loc = locationUrl ? `${locationText} (${locationUrl})` : locationText;
    const lines = [
      'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Games Lab//Events//EN','BEGIN:VEVENT',
      `DTSTAMP:${stamp(new Date())}`,`DTSTART:${stamp(dt)}`,`DTEND:${stamp(end)}`,
      `SUMMARY:${title}`,`LOCATION:${loc.replace(/,/g,'\\,')}`,`DESCRIPTION:${description}`,
      'END:VEVENT','END:VCALENDAR'
    ];
    return 'data:text/calendar;charset=utf8,' + encodeURIComponent(lines.join('\r\n'));
  }

  const scHeading = document.getElementById('scheduleHeading');
  const scBlock   = document.getElementById('scheduleBlock');
  const scWhen    = document.getElementById('scWhen');
  const scWhere   = document.getElementById('scWhere');
  const scAdd     = document.getElementById('scAddCal');
  const scDir     = document.getElementById('scDir');
  const scBook    = document.getElementById('scBook');
  const fabBook   = document.getElementById('fabBook');
  const shareFab  = document.getElementById('shareFab');

  const M = {
    bar: document.getElementById('mobileInfoBar'),
    title: document.getElementById('microTitle'),
    line1: document.getElementById('microLine1'),
    line2: document.getElementById('microLine2'),
    line3: document.getElementById('microLine3'),
    L1: document.getElementById('microLeft1'),
    L2: document.getElementById('microLeft2'),
    L3: document.getElementById('microLeft3'),
    A1: document.getElementById('microAction1'),
    A2: document.getElementById('microAction2'),
    R0: document.getElementById('microRightTitle'),
    R1: document.getElementById('microRight1'),
    R2: document.getElementById('microRight2'),
    R3: document.getElementById('microRight3'),
  };

  const fallbackTicket = {{ page.ticket_link | jsonify }} || '';
  const dFormat = "{{ page.highlights.format | default: 'Social deduction' | escape }}";
  const dDuration = "{{ page.highlights.duration | default: '3–4 hours' | escape }}";
  const dGroup = "{{ page.highlights.group_size | default: '8–25 players' | escape }}";
  const dDiff = "{{ page.highlights.difficulty | default: 'Beginner-friendly' | escape }}";
  const dPrice = "{{ page.highlights.price | default: '₹ 350/-' | escape }}";

  const next = scheduleData && scheduleData.next ? scheduleData.next : null;
  const ticket = (scheduleData && scheduleData.ticket_url) ? scheduleData.ticket_url : fallbackTicket;
  const scheduled = Boolean(next && next.start_iso);
  const startIso = next && (next.start_iso || next.start_utc);
  const base = startIso ? new Date(startIso) : null;
  const timeStr = next && next.time_label ? next.time_label : '';
  const dateStr = next && next.date_label ? next.date_label : '';
  const locText = next && next.location_name ? next.location_name : '';
  const locLink = next && next.location_url ? next.location_url : '';
  const durationHours = (next && typeof next.duration_hours === 'number' && next.duration_hours > 0) ? next.duration_hours : 3;

  function assignText(el, value){
    if (!el) return;
    const text = (value || '').trim();
    if (text){
      el.textContent = text;
      el.removeAttribute('hidden');
    } else {
      el.textContent = '';
      el.setAttribute('hidden','');
    }
  }

  function updateFabSpacing(){
    const docEl = document.documentElement;
    const bookVisible = fabBook && !fabBook.hasAttribute('hidden');
    let bookHeight = 0;
    if (bookVisible){
      const rect = fabBook.getBoundingClientRect();
      bookHeight = rect.height || fabBook.offsetHeight || 0;
      if (!bookHeight){ requestAnimationFrame(updateFabSpacing); return; }
    }

    let shareBottom = 12;
    if (shareFab){
      if (bookVisible){ shareBottom += Math.round(bookHeight + 8); }
      docEl.style.setProperty('--fab-share-bottom', shareBottom + 'px');
    }

    let pad = 16;
    if (bookVisible && window.innerWidth < 960){
      pad = Math.max(22, Math.round(bookHeight + 22));
    }
    docEl.style.setProperty('--mobile-bottom-pad', pad + 'px');
  }

  if (scheduled && base && !Number.isNaN(base.getTime())){
    scHeading && scHeading.removeAttribute('hidden');
    if (scBlock) scBlock.hidden = false;
    if (scWhen) scWhen.textContent = dateStr || '';
    if (scWhere) scWhere.textContent = locText || '';
    if (scAdd) scAdd.href = makeICS({ title: titleFallback, start: base, durationHours, locationText: locText, locationUrl: locLink, description: location.href });
    if (scDir && locLink){ scDir.href = locLink; }
    if (ticket){
      if (scBook) scBook.href = ticket;
      if (fabBook){
        fabBook.href = ticket;
        fabBook.removeAttribute('hidden');
      }
      requestAnimationFrame(updateFabSpacing);
    } else {
      if (fabBook){ fabBook.setAttribute('hidden',''); }
      updateFabSpacing();
    }
  } else {
    scHeading && scHeading.setAttribute('hidden','');
    if (scBlock) scBlock.hidden = true;
    if (fabBook){ fabBook.setAttribute('hidden',''); }
    if (scDir){ scDir.removeAttribute('href'); }
    updateFabSpacing();
  }

  if (M.title) M.title.textContent = titleFallback;
  if (scheduled && base && !Number.isNaN(base.getTime())){
    assignText(M.R0, '');
    const line1Parts = [];
    if (dateStr) line1Parts.push(dateStr);
    if (timeStr) line1Parts.push(timeStr);
    assignText(M.L1, line1Parts.join(' | '));
    if (M.line1){
      if (line1Parts.length){ M.line1.removeAttribute('hidden'); }
      else { M.line1.setAttribute('hidden',''); }
    }
    assignText(M.R1, '');
    if (M.A1){
      M.A1.textContent = 'Add to Calendar';
      M.A1.href = makeICS({ title: titleFallback, start: base, durationHours, locationText: locText, locationUrl: locLink, description: location.href });
      M.A1.hidden = false;
    }

    assignText(M.L2, locText);
    if (M.line2){
      if (locText) M.line2.removeAttribute('hidden');
      else M.line2.setAttribute('hidden','');
    }
    if (M.A2){
      if (locLink){
        M.A2.textContent = 'Get Directions';
        M.A2.href = locLink;
        M.A2.hidden = false;
      } else {
        M.A2.hidden = true;
        M.A2.removeAttribute('href');
      }
    }

    if (M.line3) M.line3.setAttribute('hidden','');
    assignText(M.R2, '');
    assignText(M.R3, '');
  } else {
    assignText(M.R0, dGroup);
    const hasLine1 = Boolean((dFormat || '').trim() || (dDuration || '').trim());
    if (M.line1){ hasLine1 ? M.line1.removeAttribute('hidden') : M.line1.setAttribute('hidden',''); }
    if (M.L1) M.L1.textContent = dFormat;
    assignText(M.R1, dDuration);
    if (M.A1){ M.A1.hidden = true; M.A1.removeAttribute('href'); }

    const hasLine2 = Boolean((dDiff || '').trim() || (dPrice || '').trim());
    if (M.line2){ hasLine2 ? M.line2.removeAttribute('hidden') : M.line2.setAttribute('hidden',''); }
    if (M.L2) M.L2.textContent = dDiff;
    assignText(M.R2, dPrice);
    if (M.A2){ M.A2.hidden = true; M.A2.removeAttribute('href'); }

    if (M.line3) M.line3.setAttribute('hidden','');
    assignText(M.R3, '');
  }

  (function(){
    const microbar = M.bar;
    const banner = document.querySelector('.banner');
    if (!microbar || !banner) return;
    function isDesktop(){ return window.innerWidth >= 960; }
    function update(){
      if (isDesktop()){ microbar.classList.remove('show'); microbar.setAttribute('aria-hidden','true'); return; }
      const topbarH = (document.querySelector('.topbar')?.offsetHeight || 56);
      const rect = banner.getBoundingClientRect();
      const bottomY = rect.bottom + window.scrollY;
      const shouldShow = window.scrollY >= (bottomY - topbarH);
      microbar.classList.toggle('show', shouldShow);
      microbar.setAttribute('aria-hidden', shouldShow ? 'false' : 'true');
    }
    window.addEventListener('load', update, { passive:true });
    window.addEventListener('scroll', update, { passive:true });
    window.addEventListener('resize', update);
    window.__updateMicrobarVis = update;
  })();

  updateFabSpacing();
  window.addEventListener('resize', updateFabSpacing);

  (function(){
    async function sharePage(){
      const data = { title: document.title, text: document.title, url: location.href };
      try{
        if (navigator.share) await navigator.share(data);
        else { await navigator.clipboard.writeText(data.url); alert('Link copied to clipboard'); }
      }catch(e){}
    }
    document.getElementById('shareBtnSide')?.addEventListener('click', sharePage);
    shareFab?.addEventListener('click', sharePage);
  })();
})();
</script>

{% include scripts-contact-phone.html %}

<!-- Video Lightbox -->
<script>
(function(){
  const modal  = document.getElementById('vidModal');
  const stage  = document.getElementById('vidStage');
  const frame  = document.getElementById('vidFrame');
  const close  = document.getElementById('vidClose');
  if (!modal || !frame || !stage) return;

  function openFrom(el){
    const url = el.getAttribute('data-embed') || el.querySelector('iframe')?.src || '';
    const withAuto = url + (url.includes('?') ? '&' : '?') + 'autoplay=1';
    if (el.classList.contains('video-portrait')) stage.classList.add('portrait'); else stage.classList.remove('portrait');
    frame.src = withAuto;
    modal.hidden = false;
  }
  function shut(){ frame.src = 'about:blank'; modal.hidden = true; }

  document.querySelectorAll('[data-embed], .video-portrait').forEach(v => {
    v.addEventListener('click', () => openFrom(v));
  });
  close.addEventListener('click', shut);
  modal.addEventListener('click', (e)=>{ if (e.target === modal) shut(); });
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !modal.hidden) shut(); });
})();
</script>
