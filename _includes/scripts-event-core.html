<script>
// Microbar visibility (mobile)
(function(){
  const microbar    = document.getElementById('mobileInfoBar');
  const highlights  = document.getElementById('highlightsMobile');
  const banner      = document.querySelector('.banner');
  if (!microbar) return;

  function isDesktop(){ return window.innerWidth >= 960; }
  function triggerEl(){ return (highlights && !highlights.hasAttribute('hidden')) ? highlights : (banner || document.body); }

  function update(){
    if (isDesktop()){ microbar.classList.remove('show'); microbar.setAttribute('aria-hidden','true'); return; }
    const topbarH = (document.querySelector('.topbar')?.offsetHeight || 56);
    const el = triggerEl(); const rect = el.getBoundingClientRect(); const bottomY = rect.bottom + window.scrollY;
    const shouldShow = window.scrollY >= (bottomY - topbarH);
    microbar.classList.toggle('show', shouldShow);
    microbar.setAttribute('aria-hidden', shouldShow ? 'false' : 'true');
  }

  window.addEventListener('load', update, { passive:true });
  window.addEventListener('scroll', update, { passive:true });
  window.addEventListener('resize', update);
  window.__updateMicrobarVis = update;
})();

// Share handlers (near title, side card, FAB)
(function(){
  async function sharePage(){
    const data = { title: document.title, text: document.title, url: location.href };
    try{
      if (navigator.share) await navigator.share(data);
      else { await navigator.clipboard.writeText(data.url); alert('Link copied to clipboard'); }
    }catch(e){}
  }
  document.getElementById('shareBtnSide')?.addEventListener('click', sharePage);
  document.getElementById('shareFab')?.addEventListener('click', sharePage);
  document.getElementById('shareNearTitle')?.addEventListener('click', sharePage);
})();

// Sheet wiring (kept exactly as current behavior)
(async function(){
  const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSs9vlFaLhdFNFXvWsBIXlAJu0J5Dj2deY_7SlwAGd9Jk1-djK6xP3rdXim7Co0BJ-pUJueDCYYugew/pub?gid=1356004046&single=true&output=csv";
  const pagePath = location.pathname.replace(/\/+$/,'') || '/';
  const eventTitle = document.getElementById('eventTitle')?.textContent.trim() || document.title;

  function clean(v){ if (v===undefined || v===null) return ""; return String(v).trim().replace(/^\"|\"$/g, ''); }
  function parseEventDate(str) {
    if (!str) return null;
    str = str.trim().replace(/^[A-Za-z]{3},?\s*/, '').replace(/’/g,"'").replace(/`/g,"'");
    const m = str.match(/^(\d{1,2})\s+([A-Za-z]{3})\s+'(\d{2})$/);
    if (!m) return null;
    const day = parseInt(m[1],10);
    const month = { Jan:0, Feb:1, Mar:2, Apr:3, May:4, Jun:5, Jul:6, Aug:7, Sep:8, Oct:9, Nov:10, Dec:11 }[m[2]];
    const year = 2000 + parseInt(m[3],10);
    return new Date(year, month, day);
  }
  function pad(n){ return String(n).padStart(2,'0'); }
  function fmtDateOnly(d){
    const dt = new Date(d);
    const wk = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dt.getDay()];
    const day = String(dt.getDate()).padStart(2,'0');
    const mon = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][dt.getMonth()];
    const yr2 = String(dt.getFullYear()).slice(-2);
    return `${wk}, ${day} ${mon} '${yr2}`;
  }
  function makeICS({title, start, durationHours=3, locationText='', locationUrl='', description=''}){
    const dt = new Date(start);
    const end = new Date(dt.getTime() + durationHours*60*60*1000);
    const stamp = (x)=> x.getFullYear()+pad(x.getMonth()+1)+pad(x.getDate())+'T'+pad(x.getHours())+pad(x.getMinutes())+pad(x.getSeconds());
    const loc = locationUrl ? `${locationText} (${locationUrl})` : locationText;
    const lines = [
      'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Games Lab//Events//EN','BEGIN:VEVENT',
      `DTSTAMP:${stamp(new Date())}`,`DTSTART:${stamp(dt)}`,`DTEND:${stamp(end)}`,
      `SUMMARY:${title}`,`LOCATION:${loc.replace(/,/g,'\\,')}`,`DESCRIPTION:${description}`,
      'END:VEVENT','END:VCALENDAR'
    ];
    return 'data:text/calendar;charset=utf8,' + encodeURIComponent(lines.join('\r\n'));
  }

  try{
    const res = await fetch(SHEET_URL + '&cb=' + Date.now(), { cache:'no-store' });
    const text = await res.text();
    const rows = Papa.parse(text, { header:true, skipEmptyLines:true }).data;

    const match = rows.find(r=>{
      const pageLink = clean(r['Page Link']).replace(/\/+$/,'');
      const name = clean(r['EventName']);
      return (pageLink && pagePath.endsWith(pageLink)) || name.toLowerCase() === eventTitle.toLowerCase();
    });
    const highlightsMobile = document.getElementById('highlightsMobile');
    if (!match){ if (highlightsMobile) highlightsMobile.setAttribute('hidden',''); return; }

    const scheduled = clean(match['Scheduled']).toLowerCase()==='yes';
    const dateStr = clean(match['Date']);
    const timeStr = clean(match['Time']);
    const locText = clean(match['Location']);
    const locLink = clean(match['Location Link']);
    const ticket  = clean(match['Ticket Link']);
    const title   = clean(match['EventName']) || eventTitle;

    // parse time
    const base = parseEventDate(dateStr);
    (function(t){
      const m = t && t.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
      let h=19, min=0;
      if (m){ h = parseInt(m[1],10); min = parseInt(m[2],10); const ap = m[3].toUpperCase(); if (ap==='PM' && h<12) h+=12; if (ap==='AM' && h===12) h=0; }
      if (base) base.setHours(h, min, 0, 0);
    })(timeStr);

    // Desktop schedule widgets
    const scBlock = document.getElementById('scheduleBlock');
    const scWhen  = document.getElementById('scWhen');
    const scWhere = document.getElementById('scWhere');
    const scAdd   = document.getElementById('scAddCal');
    const scDir   = document.getElementById('scDir');
    const scBook  = document.getElementById('scBook');

    if (scheduled && base){
      scWhen.textContent  = fmtDateOnly(base);
      scWhere.textContent = locText || '';
      scAdd.href = makeICS({ title, start: base, durationHours: 3, locationText: locText, locationUrl: locLink, description: location.href });
      if (locLink) scDir.href = locLink;
      if (ticket) scBook.href = ticket;
      document.getElementById('scheduleHeading')?.removeAttribute('hidden');
      scBlock.hidden = false;
      document.getElementById('highlightsMobile')?.removeAttribute('hidden');

      const fab = document.getElementById('fabBook');
      if (fab){ if (ticket){ fab.href = ticket; fab.removeAttribute('hidden'); } else { fab.setAttribute('hidden',''); } }
      document.getElementById('shareFab')?.classList.remove('with-text');
    } else {
      document.getElementById('scheduleHeading')?.setAttribute('hidden','');
      scBlock.hidden = true;
      document.getElementById('highlightsMobile')?.setAttribute('hidden','');
      const fab = document.getElementById('fabBook'); if (fab) fab.setAttribute('hidden','');
      document.getElementById('shareFab')?.classList.add('with-text');
    }

    // Microbar content
    (function(){
      const titleEl = document.getElementById('microTitle');
      const dateEl  = document.getElementById('microDateTime');
      const locEl   = document.getElementById('microLocation');
      const rightEl = document.getElementById('microRight');
      const esc = s => (s||'').replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));

      if (titleEl) titleEl.textContent = title;

      if (scheduled && base){
        const timePart = timeStr && timeStr.trim() ? ` | ${timeStr.trim()}` : '';
        if (dateEl) dateEl.textContent = `${fmtDateOnly(base)}${timePart}`;
        if (locEl)  locEl.textContent  = locText || '';

        const icsForBar = makeICS({ title, start: base, durationHours: 2, locationText: locText, locationUrl: locLink, description: location.href });
        const addCal = `<a class="microbar-link" id="addCalMobile" href="${esc(icsForBar)}" download>Add to Calendar</a>`;
        const dir    = locLink
          ? `<a class="microbar-link" id="getDirectionsMobile" href="${esc(locLink)}" target="_blank" rel="noopener" data-newtab="true">Get Directions</a>`
          : `<span class="microbar-link" aria-disabled="true" style="opacity:.7">Get Directions</span>`;
        if (rightEl) rightEl.innerHTML = `${addCal}${dir}`;
      } else {
        if (dateEl) dateEl.textContent = 'Social deduction';
        if (locEl)  locEl.textContent  = 'Beginner-friendly';
        if (rightEl) rightEl.innerHTML =
          `<span class="microbar-link">8–25 players</span>` +
          `<span class="microbar-link">3–4 hours</span>` +
          `<span class="microbar-link">₹ 350/-</span>`;
      }

      window.__updateMicrobarVis && window.__updateMicrobarVis();
    })();

    window.__updateMicrobarVis && window.__updateMicrobarVis();
  } catch(e){ console.error('Sheet load failed', e); }
})();

// Video Lightbox
(function(){
  const modal  = document.getElementById('vidModal');
  const stage  = document.getElementById('vidStage');
  const frame  = document.getElementById('vidFrame');
  const close  = document.getElementById('vidClose');
  if (!modal || !frame || !stage) return;

  function openFrom(el){
    const url = el.getAttribute('data-embed') || el.querySelector('iframe')?.src || '';
    const withAuto = url + (url.includes('?') ? '&' : '?') + 'autoplay=1';
    if (el.classList.contains('video-portrait')) stage.classList.add('portrait'); else stage.classList.remove('portrait');
    frame.src = withAuto; modal.hidden = false;
  }
  function shut(){ frame.src = 'about:blank'; modal.hidden = true; }
  document.querySelectorAll('[data-embed], .video-portrait').forEach(v => v.addEventListener('click', () => openFrom(v)));
  close.addEventListener('click', shut);
  modal.addEventListener('click', (e)=>{ if (e.target === modal) shut(); });
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !modal.hidden) shut(); });
})();
</script>
