<!-- =========================
     _includes/scripts-event-core.html
     ========================= -->

<!-- Microbar visibility (mobile) -->
<script>
(function(){
  const microbar   = document.getElementById('mobileInfoBar');
  const highlights = document.getElementById('highlightsMobile');
  const banner     = document.querySelector('.banner');
  if (!microbar) return;

  function isDesktop(){ return window.innerWidth >= 960; }
  function triggerEl(){
    if (highlights && !highlights.hasAttribute('hidden')) return highlights;
    return banner || document.body;
  }

  function update(){
    if (isDesktop()){
      microbar.classList.remove('show');
      microbar.setAttribute('aria-hidden','true');
      return;
    }
    const topbarH = (document.querySelector('.topbar')?.offsetHeight || 56);
    const el      = triggerEl();
    const rect    = el.getBoundingClientRect();
    const bottomY = rect.bottom + window.scrollY;
    const shouldShow = window.scrollY >= (bottomY - topbarH);
    microbar.classList.toggle('show', shouldShow);
    microbar.setAttribute('aria-hidden', shouldShow ? 'false' : 'true');
  }

  window.addEventListener('load',   update, { passive:true });
  window.addEventListener('scroll', update, { passive:true });
  window.addEventListener('resize', update);
  window.__updateMicrobarVis = update;
})();
</script>

<!-- Share: side-card button + FAB only -->
<script>
(function(){
  async function sharePage(){
    const data = { title: document.title, text: document.title, url: location.href };
    try{
      if (navigator.share) await navigator.share(data);
      else { await navigator.clipboard.writeText(data.url); alert('Link copied to clipboard'); }
    }catch(e){}
  }
  document.getElementById('shareBtnSide')?.addEventListener('click', sharePage);
  document.getElementById('shareFab')?.addEventListener('click', sharePage);
})();
</script>

<!-- Load event data from sheet + wire schedule/microbar/FABs -->
<script>
(async function(){
  const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSs9vlFaLhdFNFXvWsBIXlAJu0J5Dj2deY_7SlwAGd9Jk1-djK6xP3rdXim7Co0BJ-pUJueDCYYugew/pub?gid=1356004046&single=true&output=csv";
  const pagePath  = location.pathname.replace(/\/+$/,'') || '/';
  const eventTitle = document.getElementById('eventTitle')?.textContent.trim() || '';

  // helpers
  function clean(v){ if (v===undefined || v===null) return ""; return String(v).trim().replace(/^\"|\"$/g, ''); }
  function parseEventDate(str) {
    if (!str) return null;
    str = str.trim().replace(/^[A-Za-z]{3},?\s*/, '').replace(/’/g,"'").replace(/`/g,"'");
    const m = str.match(/^(\d{1,2})\s+([A-Za-z]{3})\s+'(\d{2})$/);
    if (!m) return null;
    const day = parseInt(m[1],10);
    const month = { Jan:0, Feb:1, Mar:2, Apr:3, May:4, Jun:5, Jul:6, Aug:7, Sep:8, Oct:9, Nov:10, Dec:11 }[m[2]];
    const year = 2000 + parseInt(m[3],10);
    return new Date(year, month, day);
  }
  function fmtDateOnly(d){
    const dt  = new Date(d);
    const wk  = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dt.getDay()];
    const day = String(dt.getDate()).padStart(2,'0');
    const mon = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][dt.getMonth()];
    const yr2 = String(dt.getFullYear()).slice(-2);
    return `${wk}, ${day} ${mon} '${yr2}`;
  }
  function makeICS({title, start, durationHours=3, locationText='', locationUrl='', description=''}){
    const pad = n => String(n).padStart(2,'0');
    const dt  = new Date(start);
    const end = new Date(dt.getTime() + durationHours*60*60*1000);
    const stamp = (x)=> x.getFullYear()+pad(x.getMonth()+1)+pad(x.getDate())+'T'+pad(x.getHours())+pad(x.getMinutes())+pad(x.getSeconds());
    const loc = locationUrl ? `${locationText} (${locationUrl})` : locationText;
    const lines = [
      'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Games Lab//Events//EN','BEGIN:VEVENT',
      `DTSTAMP:${stamp(new Date())}`,`DTSTART:${stamp(dt)}`,`DTEND:${stamp(end)}`,
      `SUMMARY:${title}`,`LOCATION:${loc.replace(/,/g,'\\,')}`,`DESCRIPTION:${description}`,
      'END:VEVENT','END:VCALENDAR'
    ];
    return 'data:text/calendar;charset=utf8,' + encodeURIComponent(lines.join('\r\n'));
  }

  // DOM refs
  const scBlock = document.getElementById('scheduleBlock');
  const scWhen  = document.getElementById('scWhen');
  const scWhere = document.getElementById('scWhere');
  const scAdd   = document.getElementById('scAddCal');
  const scDir   = document.getElementById('scDir');
  const scBook  = document.getElementById('scBook');

  const fabBook = document.getElementById('fabBook');
  const shareFab= document.getElementById('shareFab');
  const wrapEl  = document.querySelector('.wrap');

  try{
    const res  = await fetch(SHEET_URL + '&cb=' + Date.now(), { cache:'no-store' });
    const text = await res.text();
    const rows = Papa.parse(text, { header:true, skipEmptyLines:true }).data;

    const match = rows.find(r=>{
      const pageLink = clean(r['Page Link']).replace(/\/+$/,'');
      const name     = clean(r['EventName']);
      return (pageLink && pagePath.endsWith(pageLink)) || (eventTitle && name.toLowerCase() === eventTitle.toLowerCase());
    });

    // If no match → treat as not-scheduled defaults for microbar/FABs
    if (!match){
      document.getElementById('scheduleHeading')?.setAttribute('hidden','');
      if (scBlock) scBlock.hidden = true;
      if (fabBook) fabBook.setAttribute('hidden','');
      if (wrapEl)  wrapEl.classList.remove('pad-for-fab');
      if (shareFab){ shareFab.classList.add('with-text'); shareFab.classList.remove('with-book'); }

      // Microbar (not scheduled)
      {
        const title = eventTitle || 'Event';
        const t  = document.getElementById('microTitle');
        const l2 = document.getElementById('microDateTime');
        const l3 = document.getElementById('microLocation');
        const r  = document.getElementById('microRight');
        if (t)  t.textContent  = title;
        if (l2) l2.textContent = 'Social deduction';
        if (l3) l3.textContent = 'Beginner friendly';
        if (r){
          r.innerHTML =
            `<span class="microbar-link">8–25 players</span>` +
            `<span class="microbar-link">3–4 hours</span>` +
            `<span class="microbar-link">₹ 350/-</span>`;
        }
      }
      window.__updateMicrobarVis && window.__updateMicrobarVis();
      return;
    }

    // Extract matched row
    const scheduled = clean(match['Scheduled']).toLowerCase()==='yes';
    const dateStr   = clean(match['Date']);
    const timeStr   = clean(match['Time']);
    const locText   = clean(match['Location']);
    const locLink   = clean(match['Location Link']);
    const ticket    = clean(match['Ticket Link']);
    const title     = clean(match['EventName']) || (eventTitle || 'Event');

    // Build Date + time (12h)
    const base = parseEventDate(dateStr);
    if (base){
      let hh=19, mm=0;
      const m = timeStr.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
      if (m){
        hh = parseInt(m[1],10); mm = parseInt(m[2],10);
        const ap = m[3].toUpperCase();
        if (ap==='PM' && hh<12) hh+=12;
        if (ap==='AM' && hh===12) hh=0;
      }
      base.setHours(hh, mm, 0, 0);
    }

    if (scheduled && base){
      // Desktop schedule
      if (scWhen)  scWhen.textContent  = fmtDateOnly(base);
      if (scWhere) scWhere.textContent = locText || '';
      if (scAdd){
        scAdd.href = makeICS({
          title, start: base, durationHours: 3,
          locationText: locText, locationUrl: locLink, description: location.href
        });
        scAdd.textContent = 'Add to Calendar';
      }
      if (scDir){
        if (locLink){ scDir.href = locLink; scDir.textContent = 'Get directions'; }
        else { scDir.removeAttribute('href'); scDir.textContent = 'Get directions'; }
      }
      if (ticket && scBook) scBook.href = ticket;

      document.getElementById('scheduleHeading')?.removeAttribute('hidden');
      if (scBlock) scBlock.hidden = false;

      // Microbar (scheduled)
      {
        const t  = document.getElementById('microTitle');
        const l2 = document.getElementById('microDateTime');
        const l3 = document.getElementById('microLocation');
        const r  = document.getElementById('microRight');

        if (t)  t.textContent  = title;
        if (l2) l2.textContent = timeStr ? `${fmtDateOnly(base)} | ${timeStr}` : fmtDateOnly(base);
        if (l3) l3.textContent = locText || '';

        if (r){
          const icsForBar = makeICS({
            title, start: base, durationHours: 2,
            locationText: locText, locationUrl: locLink, description: location.href
          });
          const esc = s => (s||'').replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
          r.innerHTML =
            `<a class="microbar-link" id="addCalMobile" href="${esc(icsForBar)}" download>Add to Calendar</a>` +
            (locLink
              ? `<a class="microbar-link" id="getDirectionsMobile" href="${esc(locLink)}" target="_blank" rel="noopener">Get Directions</a>`
              : `<span class="microbar-link" aria-disabled="true" style="opacity:.7">Get Directions</span>`);
        }
      }

      // FABs + bottom padding
      if (fabBook){
        if (ticket){ fabBook.href = ticket; fabBook.removeAttribute('hidden'); }
        else       { fabBook.setAttribute('hidden',''); }
      }
      if (shareFab){
        if (ticket){ shareFab.classList.add('with-book'); shareFab.classList.remove('with-text'); }
        else       { shareFab.classList.remove('with-book'); shareFab.classList.add('with-text'); }
      }
      if (wrapEl){
        if (ticket) wrapEl.classList.add('pad-for-fab');
        else        wrapEl.classList.remove('pad-for-fab');
      }

    } else {
      // Not scheduled
      document.getElementById('scheduleHeading')?.setAttribute('hidden','');
      if (scBlock) scBlock.hidden = true;
      if (fabBook) fabBook.setAttribute('hidden','');
      if (wrapEl)  wrapEl.classList.remove('pad-for-fab');
      if (shareFab){
        shareFab.classList.add('with-text');
        shareFab.classList.remove('with-book');
      }

      // Microbar (3-line stats)
      {
        const t  = document.getElementById('microTitle');
        const l2 = document.getElementById('microDateTime');
        const l3 = document.getElementById('microLocation');
        const r  = document.getElementById('microRight');

        if (t)  t.textContent  = title;
        if (l2) l2.textContent = 'Social deduction';
        if (l3) l3.textContent = 'Beginner friendly';

        if (r){
          r.innerHTML =
            `<span class="microbar-link">8–25 players</span>` +
            `<span class="microbar-link">3–4 hours</span>` +
            `<span class="microbar-link">₹ 350/-</span>`;
        }
      }
    }

    window.__updateMicrobarVis && window.__updateMicrobarVis();

  }catch(e){
    console.error('Sheet load failed', e);
  }
})();
</script>

<!-- Video Lightbox (portrait/landscape aware) -->
<script>
(function(){
  const modal = document.getElementById('vidModal');
  const stage = document.getElementById('vidStage');
  const frame = document.getElementById('vidFrame');
  const close = document.getElementById('vidClose');
  if (!modal || !frame || !stage) return;

  function openFrom(el){
    const url   = el.getAttribute('data-embed') || el.querySelector('iframe')?.src || '';
    const withA = url + (url.includes('?') ? '&' : '?') + 'autoplay=1';
    if (el.classList.contains('video-portrait')) stage.classList.add('portrait');
    else stage.classList.remove('portrait');
    frame.src = withA;
    modal.hidden = false;
  }
  function shut(){ frame.src='about:blank'; modal.hidden=true; }

  document.querySelectorAll('[data-embed], .video-portrait').forEach(v=>{
    v.addEventListener('click', ()=>openFrom(v));
  });
  close.addEventListener('click', shut);
  modal.addEventListener('click', (e)=>{ if (e.target === modal) shut(); });
  window.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && !modal.hidden) shut(); });
})();
</script>
