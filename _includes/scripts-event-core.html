<script>
(async function(){
  const CALENDAR_URL = "{{ site.baseurl | default: '' }}/assets/data/calendar.json";
  const BASEURL = "{{ site.baseurl | default: '' }}";
  const PAGE_SLUG = {{ page.slug | jsonify }} || '';
  const CLEAN = v => (v == null) ? "" : String(v).trim();

  function stripDomain(p){ return p.replace(/^https?:\/\/[^/]+/, ''); }
  function stripBaseAndSlash(p){
    let x = stripDomain(p);
    if (BASEURL && x.startsWith(BASEURL)) x = x.slice(BASEURL.length);
    return x.replace(/\/+$/, '');
  }

  const pagePath = stripBaseAndSlash(location.pathname || '/');
  const titleFallback = (document.getElementById('eventTitle')?.textContent || '').trim();

  function normalizeSlug(value){
    if (!value) return '';
    return value.toString()
      .normalize('NFKD')
      .replace(/[\u0300-\u036f]/g,'')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g,'-')
      .replace(/^-+|-+$/g,'');
  }

  function fmtDateOnly(date, timezone){
    const parts = new Intl.DateTimeFormat('en-US', {
      weekday: 'short',
      day: '2-digit',
      month: 'short',
      year: '2-digit',
      timeZone: timezone
    }).formatToParts(date).reduce((acc, part) => {
      if (part.type !== 'literal') acc[part.type] = part.value;
      return acc;
    }, {});
    return `${parts.weekday || ''}, ${parts.day || ''} ${parts.month || ''} '${parts.year || ''}`.trim();
  }

  function fmtTime(date, timezone){
    const str = new Intl.DateTimeFormat('en-US', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: true,
      timeZone: timezone
    }).format(date).replace(/\u202f/g, ' ');
    return str.toUpperCase();
  }

  function dayKey(date, timezone){
    return new Intl.DateTimeFormat('en-CA', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      timeZone: timezone
    }).format(date);
  }

  function parseStart(entry){
    if (!entry || !entry.start) return null;
    const d = new Date(entry.start);
    return isNaN(d.getTime()) ? null : d;
  }

  function makeICS({title, start, durationHours=3, locationText='', locationUrl='', description=''}){
    const dt = new Date(start);
    const end = new Date(dt.getTime() + durationHours*60*60*1000);
    const pad = n => String(n).padStart(2,'0');
    const stamp = (x)=> x.getUTCFullYear()+pad(x.getUTCMonth()+1)+pad(x.getUTCDate())+'T'+pad(x.getUTCHours())+pad(x.getUTCMinutes())+pad(x.getUTCSeconds())+'Z';
    const loc = locationUrl ? `${locationText} (${locationUrl})` : locationText;
    const lines = [
      'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Games Lab//Events//EN','BEGIN:VEVENT',
      `DTSTAMP:${stamp(new Date())}`,`DTSTART:${stamp(dt)}`,`DTEND:${stamp(end)}`,
      `SUMMARY:${title}`,`LOCATION:${loc.replace(/,/g,'\\,')}`,`DESCRIPTION:${description}`,
      'END:VEVENT','END:VCALENDAR'
    ];
    return 'data:text/calendar;charset=utf8,' + encodeURIComponent(lines.join('\r\n'));
  }

  let match = null;
  let timezone = 'Asia/Kolkata';

  try {
    const res = await fetch(CALENDAR_URL + '?v=' + Date.now(), { cache:'no-store' });
    if (!res.ok) throw new Error('Calendar fetch failed: ' + res.status);
    const data = await res.json();
    const events = Array.isArray(data.events) ? data.events : [];
    timezone = CLEAN(data.timezone) || timezone;

    const pathSlug = normalizeSlug(pagePath.split('/').filter(Boolean).pop());

    match = events.find(entry => {
      if (!entry) return false;
      const entrySlug = normalizeSlug(entry.slug || entry.title);
      if (PAGE_SLUG && entrySlug === normalizeSlug(PAGE_SLUG)) return true;
      if (pathSlug && entrySlug === pathSlug) return true;
      if (titleFallback && entry.title && entry.title.toLowerCase() === titleFallback.toLowerCase()) return true;
      return false;
    });
  } catch (e) {
    console.error('Calendar load error', e);
  }

  const scHeading = document.getElementById('scheduleHeading');
  const scBlock   = document.getElementById('scheduleBlock');
  const scWhen    = document.getElementById('scWhen');
  const scWhere   = document.getElementById('scWhere');
  const scAdd     = document.getElementById('scAddCal');
  const scDir     = document.getElementById('scDir');
  const scBook    = document.getElementById('scBook');
  const fabBook   = document.getElementById('fabBook');
  const shareFab  = document.getElementById('shareFab');

  const M = {
    bar: document.getElementById('mobileInfoBar'),
    title: document.getElementById('microTitle'),
    line1: document.getElementById('microLine1'),
    line2: document.getElementById('microLine2'),
    line3: document.getElementById('microLine3'),
    L1: document.getElementById('microLeft1'),
    L2: document.getElementById('microLeft2'),
    L3: document.getElementById('microLeft3'),
    A1: document.getElementById('microAction1'),
    A2: document.getElementById('microAction2'),
    R0: document.getElementById('microRightTitle'),
    R1: document.getElementById('microRight1'),
    R2: document.getElementById('microRight2'),
    R3: document.getElementById('microRight3'),
  };

  const paymentButtonId = "{{ page.payment_button_id | default: '' | strip }}";
  const hasPaymentButton = Boolean(paymentButtonId);
  const hiddenPaymentForm = document.getElementById('razorpayPaymentForm');
  const dFormat = "{{ page.highlights.format | default: 'Social deduction' | escape }}";
  const dDuration = "{{ page.highlights.duration | default: '3–4 hours' | escape }}";
  const dGroup = "{{ page.highlights.group_size | default: '8–25 players' | escape }}";
  const dDiff = "{{ page.highlights.difficulty | default: 'Beginner-friendly' | escape }}";
  const dPrice = "{{ page.highlights.price | default: '₹ 350/-' | escape }}";

  function assignText(el, value){
    if (!el) return;
    const text = (value || '').trim();
    if (text){
      el.textContent = text;
      el.removeAttribute('hidden');
    } else {
      el.textContent = '';
      el.setAttribute('hidden','');
    }
  }

  function updateFabSpacing(){
    const docEl = document.documentElement;
    const bookVisible = fabBook && !fabBook.hasAttribute('hidden');
    let bookHeight = 0;
    if (bookVisible){
      const rect = fabBook.getBoundingClientRect();
      bookHeight = rect.height || fabBook.offsetHeight || 0;
      if (!bookHeight){ requestAnimationFrame(updateFabSpacing); return; }
    }

    let shareBottom = 12;
    if (shareFab){
      if (bookVisible){ shareBottom += Math.round(bookHeight + 8); }
      docEl.style.setProperty('--fab-share-bottom', shareBottom + 'px');
    }

    let pad = 16;
    if (bookVisible && window.innerWidth < 960){
      pad = Math.max(22, Math.round(bookHeight + 22));
    }
    docEl.style.setProperty('--mobile-bottom-pad', pad + 'px');
  }

  const scheduleDate = parseStart(match);
  const todayKey = dayKey(new Date(), timezone);
  const eventDayKey = scheduleDate ? dayKey(scheduleDate, timezone) : '';
  const isUpcoming = Boolean(scheduleDate) && eventDayKey >= todayKey;

  if (match?.location_warning && match.raw_location){
    console.warn('Calendar location mismatch for "%s": "%s"', titleFallback, match.raw_location);
  }

  const locationText = match?.location_name || 'To be Announced';
  const locationUrl = match?.location_map_url || '';
  const timeStr = scheduleDate ? fmtTime(scheduleDate, timezone) : '';
  const whenText = scheduleDate ? fmtDateOnly(scheduleDate, timezone) : '';
  if (M.title) M.title.textContent = titleFallback;

  if (isUpcoming && scheduleDate){
    scHeading && scHeading.removeAttribute('hidden');
    if (scBlock) scBlock.hidden = false;
    scWhen && (scWhen.textContent = whenText);
    scWhere && (scWhere.textContent = locationText || '');
    if (scAdd) scAdd.href = makeICS({ title: titleFallback, start: scheduleDate, durationHours: 3, locationText, locationUrl, description: location.href });
    if (scDir){
      if (locationUrl){
        scDir.href = locationUrl;
        scDir.removeAttribute('hidden');
      } else {
        scDir.setAttribute('hidden','');
        scDir.removeAttribute('href');
      }
    }
    if (hasPaymentButton){
      if (scBook) scBook.removeAttribute('hidden');
      if (fabBook){
        fabBook.removeAttribute('hidden');
        requestAnimationFrame(updateFabSpacing);
      }
    } else {
      if (scBook) scBook.setAttribute('hidden','');
      if (fabBook){ fabBook.setAttribute('hidden',''); }
      updateFabSpacing();
    }
  } else {
    scHeading && scHeading.setAttribute('hidden','');
    if (scBlock) scBlock.hidden = true;
    if (scBook) scBook.setAttribute('hidden','');
    if (fabBook){ fabBook.setAttribute('hidden',''); }
    updateFabSpacing();
  }

  if (isUpcoming && scheduleDate){
    assignText(M.R0, '');
    const timePart = timeStr ? ` | ${timeStr}` : '';
    if (M.L1){ M.L1.textContent = whenText + timePart; M.line1?.removeAttribute('hidden'); }
    assignText(M.R1, '');
    if (M.A1){
      M.A1.textContent = 'Add to Calendar';
      M.A1.href = makeICS({ title: titleFallback, start: scheduleDate, durationHours: 3, locationText, locationUrl, description: location.href });
      M.A1.hidden = false;
    }

    if (M.L2){ M.L2.textContent = locationText || ''; }
    if (locationText){ M.line2?.removeAttribute('hidden'); } else { M.line2?.setAttribute('hidden',''); }
    assignText(M.R2, '');
    if (M.A2){
      if (locationUrl){
        M.A2.textContent = 'Get Directions';
        M.A2.href = locationUrl;
        M.A2.hidden = false;
      } else {
        M.A2.hidden = true;
        M.A2.removeAttribute('href');
      }
    }

    if (M.L3){ M.L3.textContent = ''; }
    assignText(M.R3, '');
    M.line3?.setAttribute('hidden','');
  } else {
    assignText(M.R0, dGroup);
    const hasLine1 = Boolean((dFormat || '').trim() || (dDuration || '').trim());
    if (M.line1){
      if (hasLine1){ M.line1.removeAttribute('hidden'); }
      else { M.line1.setAttribute('hidden',''); }
    }
    if (M.L1) M.L1.textContent = dFormat;
    assignText(M.R1, dDuration);
    if (M.A1){ M.A1.hidden = true; M.A1.removeAttribute('href'); }

    const hasLine2 = Boolean((dDiff || '').trim() || (dPrice || '').trim());
    if (M.line2){
      if (hasLine2){ M.line2.removeAttribute('hidden'); }
      else { M.line2.setAttribute('hidden',''); }
    }
    if (M.L2) M.L2.textContent = dDiff;
    assignText(M.R2, dPrice);
    if (M.A2){ M.A2.hidden = true; M.A2.removeAttribute('href'); }

    if (M.L3){ M.L3.textContent = ''; }
    assignText(M.R3, '');
    M.line3?.setAttribute('hidden','');
  }

  (function(){
    const microbar = M.bar;
    const banner = document.querySelector('.banner');
    if (!microbar || !banner) return;
    function isDesktop(){ return window.innerWidth >= 960; }
    function update(){
      if (isDesktop()){ microbar.classList.remove('show'); microbar.setAttribute('aria-hidden','true'); return; }
      const topbarH = (document.querySelector('.topbar')?.offsetHeight || 56);
      const rect = banner.getBoundingClientRect();
      const bottomY = rect.bottom + window.scrollY;
      const shouldShow = window.scrollY >= (bottomY - topbarH);
      microbar.classList.toggle('show', shouldShow);
      microbar.setAttribute('aria-hidden', shouldShow ? 'false' : 'true');
    }
    window.addEventListener('load', update, { passive:true });
    window.addEventListener('scroll', update, { passive:true });
    window.addEventListener('resize', update);
    window.__updateMicrobarVis = update;
  })();

  if (hasPaymentButton){
    const triggerPayment = (event) => {
      event?.preventDefault();
      let tries = 0;
      const attempt = () => {
        const paymentButton = hiddenPaymentForm?.querySelector('.razorpay-payment-button');
        if (paymentButton){
          paymentButton.click();
        } else if (tries < 10){
          tries += 1;
          setTimeout(attempt, 100);
        } else {
          console.warn('Razorpay payment button could not be initialized.');
        }
      };
      attempt();
    };
    scBook?.addEventListener('click', triggerPayment);
    fabBook?.addEventListener('click', triggerPayment);
  }

  updateFabSpacing();
  window.addEventListener('resize', ()=>{ updateFabSpacing(); });

  (function(){
    async function sharePage(){
      const data = { title: document.title, text: document.title, url: location.href };
      try{
        if (navigator.share) await navigator.share(data);
        else { await navigator.clipboard.writeText(data.url); alert('Link copied to clipboard'); }
      }catch(e){}
    }
    document.getElementById('shareBtnSide')?.addEventListener('click', sharePage);
    shareFab?.addEventListener('click', sharePage);
  })();
})();
</script>

{% include scripts-contact-phone.html %}

<!-- Video Lightbox -->
<script>
(function(){
  const modal  = document.getElementById('vidModal');
  const stage  = document.getElementById('vidStage');
  const frame  = document.getElementById('vidFrame');
  const close  = document.getElementById('vidClose');
  if (!modal || !frame || !stage) return;

  function buildEmbed(url){
    const result = { url: '', vendor: 'generic' };
    if (!url) return result;

    let parsed = null;
    try{
      parsed = new URL(url, window.location.href);
    }catch(err){ parsed = null; }

    const urlLower = url.toLowerCase();
    const looksYoutube = /youtube\.com|youtu\.be/.test(urlLower);

    if (parsed){
      const host = parsed.hostname.replace(/^www\./,'').toLowerCase();
      if (host === 'youtu.be'){
        const id = parsed.pathname.replace(/^\/+|\/+$/g,'');
        const carry = parsed.searchParams;
        parsed = new URL('https://www.youtube.com/embed/' + id);
        carry.forEach((value, key) => { parsed.searchParams.set(key, value); });
      }

      const normalizedHost = parsed.hostname.replace(/^www\./,'').toLowerCase();
      if (normalizedHost === 'youtube.com'){
        result.vendor = 'youtube';
        if (parsed.pathname === '/watch'){
          const vid = parsed.searchParams.get('v');
          if (vid){
            parsed.pathname = '/embed/' + vid;
            parsed.searchParams.delete('v');
          }
        } else if (parsed.pathname.startsWith('/live/')){
          const parts = parsed.pathname.split('/').filter(Boolean);
          const vid = parts.pop();
          if (vid) parsed.pathname = '/embed/' + vid;
        }
        parsed.searchParams.set('enablejsapi','1');
        if (!parsed.searchParams.has('rel')) parsed.searchParams.set('rel','0');
      }

      parsed.searchParams.set('autoplay','1');
      if (!parsed.searchParams.has('playsinline')) parsed.searchParams.set('playsinline','1');
      result.url = parsed.toString();
      return result;
    }

    let final = url;
    const extras = [];
    if (!/[?&]autoplay=/.test(final)) extras.push('autoplay=1');
    if (!/[?&]playsinline=/.test(final)) extras.push('playsinline=1');
    if (looksYoutube){
      result.vendor = 'youtube';
      if (!/[?&]enablejsapi=/.test(final)) extras.push('enablejsapi=1');
      if (!/[?&]rel=/.test(final)) extras.push('rel=0');
    }
    if (extras.length){
      final += (final.includes('?') ? '&' : '?') + extras.join('&');
    }
    result.url = final;
    return result;
  }

  function pingYoutube(){
    if (frame.dataset.vendor !== 'youtube') return;
    try{
      frame.contentWindow?.postMessage(JSON.stringify({ event:'command', func:'playVideo', args:[] }), '*');
    }catch(err){}
  }

  frame.addEventListener('load', () => {
    if (frame.dataset.vendor === 'youtube'){
      requestAnimationFrame(pingYoutube);
      setTimeout(pingYoutube, 200);
    }
  });

  function openFrom(el){
    const url = el.getAttribute('data-embed') || el.querySelector('iframe')?.src || '';
    const embed = buildEmbed(url);
    if (el.classList.contains('video-portrait')) stage.classList.add('portrait'); else stage.classList.remove('portrait');
    frame.dataset.vendor = embed.vendor;
    frame.src = embed.url || 'about:blank';
    modal.hidden = false;
    requestAnimationFrame(() => {
      try{ frame.focus({ preventScroll: true }); }
      catch(err){ try{ frame.focus(); }catch(_){} }
    });
    if (embed.vendor === 'youtube') pingYoutube();
  }
  function shut(){
    frame.src = 'about:blank';
    delete frame.dataset.vendor;
    stage.classList.remove('portrait');
    modal.hidden = true;
  }

  document.querySelectorAll('[data-embed], .video-portrait').forEach(v => {
    v.addEventListener('click', () => openFrom(v));
  });
  close.addEventListener('click', shut);
  modal.addEventListener('click', (e)=>{ if (e.target === modal) shut(); });
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !modal.hidden) shut(); });
})();
</script>
