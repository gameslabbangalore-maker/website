<script>
(function(){
  const dataEl = document.getElementById('event-data');
  let ev = {};
  try { ev = JSON.parse(dataEl?.textContent || '{}'); } catch(e){ ev = {}; }

  // ---------- helpers ----------
  const $ = s => document.querySelector(s);
  const esc = s => (s||'').replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
  const pad = n => String(n).padStart(2,'0');

  function parseDate(d, t){
    if(!d) return null;
    const base = new Date(d);
    if (t){
      const m = String(t).match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
      if (m){
        let h = +m[1], mi = +m[2]; const ap = m[3].toUpperCase();
        if (ap==='PM' && h<12) h+=12; if (ap==='AM' && h===12) h=0;
        base.setHours(h, mi, 0, 0);
      }
    }
    return base;
  }
  function fmtDateOnly(d){
    const dt = new Date(d);
    const wk = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dt.getDay()];
    const mon = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][dt.getMonth()];
    return `${wk}, ${pad(dt.getDate())} ${mon} '${String(dt.getFullYear()).slice(-2)}`;
  }
  function makeICS({title, start, durationHours=3, locationText='', locationUrl='', description=''}){
    const dt = new Date(start);
    const end = new Date(dt.getTime() + durationHours*60*60*1000);
    const stamp = x => x.getFullYear()+pad(x.getMonth()+1)+pad(x.getDate())+'T'+pad(x.getHours())+pad(x.getMinutes())+pad(x.getSeconds());
    const loc = locationUrl ? `${locationText} (${locationUrl})` : locationText;
    const lines = [
      'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Games Lab//Events//EN','BEGIN:VEVENT',
      `DTSTAMP:${stamp(new Date())}`,`DTSTART:${stamp(dt)}`,`DTEND:${stamp(end)}`,
      `SUMMARY:${title}`,`LOCATION:${loc.replace(/,/g,'\\,')}`,`DESCRIPTION:${description}`,
      'END:VEVENT','END:VCALENDAR'
    ];
    return 'data:text/calendar;charset=utf8,' + encodeURIComponent(lines.join('\r\n'));
  }

  // ---------- SCHEDULE / RIGHT CARD ----------
  (function scheduleCard(){
    const scheduled = !!ev.scheduled;
    const start = parseDate(ev.date, ev.time);
    const scBlock = $('#scheduleBlock');
    const scHead  = $('#scheduleHeading');
    const scWhen  = $('#scWhen');
    const scWhere = $('#scWhere');
    const scAdd   = $('#scAddCal');
    const scDir   = $('#scDir');
    const scBook  = $('#scBook');
    const fabBook = $('#fabBook');
    const shareFab = $('#shareFab');

    if (scheduled && start){
      scWhen && (scWhen.textContent = fmtDateOnly(start));
      scWhere && (scWhere.textContent = ev.location_text || '');
      if (scAdd){
        scAdd.href = makeICS({
          title: ev.title, start, durationHours: 3,
          locationText: ev.location_text||'', locationUrl: ev.location_link||'',
          description: location.href
        });
        scAdd.textContent = 'Add to Calendar';
      }
      if (scDir){
        scDir.textContent = 'Get directions';
        if (ev.location_link){ scDir.href = ev.location_link; scDir.target = '_blank'; scDir.rel='noopener'; }
        else { scDir.removeAttribute('href'); }
      }
      if (scBook && ev.ticket_link){ scBook.href = ev.ticket_link; }
      scHead && scHead.removeAttribute('hidden');
      scBlock && (scBlock.hidden = false);

      // Book Now FAB (mobile)
      if (fabBook && ev.ticket_link){ fabBook.href = ev.ticket_link; fabBook.removeAttribute('hidden'); }

      // Share FAB = icon-only when scheduled
      shareFab && shareFab.classList.remove('with-text');

    } else {
      scHead && scHead.setAttribute('hidden','');
      scBlock && (scBlock.hidden = true);

      // Hide Book FAB when not scheduled
      fabBook && fabBook.setAttribute('hidden','');

      // Share FAB = show text when not scheduled
      shareFab && shareFab.classList.add('with-text');
    }
  })();

  // ---------- MICROBAR (2 modes) ----------
  (function microbar(){
    const bar = $('#mobileInfoBar');
    const titleEl = $('#microTitle');
    const left1 = $('#microLeft1'); const right1 = $('#microRight1');
    const left2 = $('#microLeft2'); const right2 = $('#microRight2');
    const left3 = $('#microLeft3'); const right3 = $('#microRight3');

    if (!bar) return;
    // fill content
    titleEl && (titleEl.textContent = ev.title || '');
    if (ev.scheduled){
      // scheduled mode: keep the Add to Calendar / Directions on the RIGHT (you already have that in side card),
      // we keep microbar in simple 2-line mode for scheduled pages (title + date/time + location)
      // If you *do* want 3-line even when scheduled, uncomment below and set values.
      left1 && (left1.textContent = ev.title || '');
      right1 && (right1.textContent = (ev.group_size || '')); // optional
      left2 && (left2.textContent = (ev.location_text || ''));
      right2 && (right2.textContent = (ev.time || ''));
      left3 && (left3.textContent = '');
      right3 && (right3.textContent = '');

      bar.dataset.mode = 'scheduled';
    } else {
      // NOT scheduled → your requested 3-line text layout
      left1 && (left1.textContent = ev.title || '');
      right1 && (right1.textContent = ev.group_size || '8–25 players');

      left2 && (left2.textContent = ev.format || 'Social deduction');
      right2 && (right2.textContent = ev.duration || '3–4 hours');

      left3 && (left3.textContent = ev.difficulty || 'Beginner friendly');
      right3 && (right3.textContent = ev.price || '₹ 350/-');

      bar.dataset.mode = 'three';
    }

    function isDesktop(){ return window.innerWidth >= 960; }
    function triggerEl(){
      const highlights = document.getElementById('highlightsMobile');
      const banner = document.querySelector('.banner');
      return (highlights && !highlights.hasAttribute('hidden')) ? highlights : (banner || document.body);
    }
    function update(){
      if (isDesktop()){ bar.classList.remove('show'); bar.setAttribute('aria-hidden','true'); return; }
      const topbarH = (document.querySelector('.topbar')?.offsetHeight || 56);
      const rect = triggerEl().getBoundingClientRect();
      const bottomY = rect.bottom + window.scrollY;
      const shouldShow = window.scrollY >= (bottomY - topbarH);
      bar.classList.toggle('show', shouldShow);
      bar.setAttribute('aria-hidden', shouldShow ? 'false' : 'true');
    }
    window.addEventListener('load', update, { passive:true });
    window.addEventListener('scroll', update, { passive:true });
    window.addEventListener('resize', update);
    window.__updateMicrobarVis = update;
  })();

  // ---------- Video lightbox + click-to-play ----------
  (function videos(){
    const modal  = $('#vidModal'), stage  = $('#vidStage'), frame  = $('#vidFrame'), close  = $('#vidClose');
    if (!modal || !frame || !stage) return;
    function openFrom(el){
      const url = el.getAttribute('data-embed') || el.querySelector('iframe')?.src || '';
      const withAuto = url + (url.includes('?') ? '&' : '?') + 'autoplay=1';
      stage.classList.toggle('portrait', el.classList.contains('video-portrait'));
      frame.src = withAuto; modal.hidden = false;
    }
    function shut(){ frame.src = 'about:blank'; modal.hidden = true; }
    document.querySelectorAll('[data-embed], .video-portrait').forEach(v => v.addEventListener('click', () => openFrom(v)));
    close.addEventListener('click', shut);
    modal.addEventListener('click', e=>{ if (e.target === modal) shut(); });
    window.addEventListener('keydown', e=>{ if (e.key === 'Escape' && !modal.hidden) shut(); });
  })();

  // ---------- Share (side card + FAB) ----------
  (function share(){
    async function sharePage(){
      const data = { title: document.title, text: `Check out ${ev.title} at Games Lab`, url: location.href };
      try{
        if (navigator.share) await navigator.share(data);
        else { await navigator.clipboard.writeText(data.url); alert('Link copied to clipboard'); }
      }catch(e){}
    }
    document.getElementById('shareBtnSide')?.addEventListener('click', sharePage);
    document.getElementById('shareFab')?.addEventListener('click', sharePage);
  })();

  // ---------- Same-tab rule (site-wide, keep exceptions if needed) ----------
  (function sameTab(){
    const sel = 'a[href^="/events/"], a[href*="://gameslab.co.in/events/"]';
    const fix = (root=document) => root.querySelectorAll(sel).forEach(a => a.removeAttribute('target'));
    fix(); new MutationObserver(muts => muts.forEach(m => m.addedNodes.forEach(n => n.nodeType===1 && fix(n)))).observe(document.body, { childList:true, subtree:true });
  })();
})();
</script>
