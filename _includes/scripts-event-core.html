<script>
(function(){
  const schedule = {{ site.data.event_schedule | jsonify }} || {};
  const pageSlug = {{ page.slug | jsonify }};
  const fallbackTicket = {{ page.ticket_link | jsonify }} || '';
  const fallbackTitle = (document.getElementById('eventTitle')?.textContent || '').trim();

  const dFormat = "{{ page.highlights.format | default: 'Social deduction' | escape }}";
  const dDuration = "{{ page.highlights.duration | default: '3–4 hours' | escape }}";
  const dGroup = "{{ page.highlights.group_size | default: '8–25 players' | escape }}";
  const dDiff = "{{ page.highlights.difficulty | default: 'Beginner-friendly' | escape }}";
  const dPrice = "{{ page.highlights.price | default: '₹ 350/-' | escape }}";

  function pickEventEntry(){
    if (!schedule.by_slug) return null;
    if (pageSlug && schedule.by_slug[pageSlug]) return schedule.by_slug[pageSlug];
    const normalized = fallbackTitle.toLowerCase();
    if (!normalized) return null;
    for (const key in schedule.by_slug){
      const entry = schedule.by_slug[key];
      if ((entry.title || '').toLowerCase() === normalized){
        return entry;
      }
    }
    return null;
  }

  function fmtDateOnly(date){
    if (!date) return '';
    const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const wk = weekdays[date.getDay()];
    const day = String(date.getDate()).padStart(2,'0');
    const mon = months[date.getMonth()];
    const yr2 = String(date.getFullYear()).slice(-2);
    return `${wk}, ${day} ${mon} '${yr2}`;
  }

  function makeICS({ title, start, end, locationText = '', locationUrl = '', description = '' }){
    if (!start) return '#';
    const startDate = new Date(start);
    const endDate = end ? new Date(end) : new Date(startDate.getTime() + 3 * 60 * 60 * 1000);
    const pad = n => String(n).padStart(2,'0');
    const stamp = dt => `${dt.getFullYear()}${pad(dt.getMonth()+1)}${pad(dt.getDate())}T${pad(dt.getHours())}${pad(dt.getMinutes())}${pad(dt.getSeconds())}`;
    const loc = locationUrl ? `${locationText} (${locationUrl})` : locationText;
    const lines = [
      'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Games Lab//Events//EN','BEGIN:VEVENT',
      `DTSTAMP:${stamp(new Date())}`,
      `DTSTART:${stamp(startDate)}`,
      `DTEND:${stamp(endDate)}`,
      `SUMMARY:${title}`,
      `LOCATION:${(loc || '').replace(/,/g,'\\,')}`,
      `DESCRIPTION:${description || ''}`,
      'END:VEVENT','END:VCALENDAR'
    ];
    return 'data:text/calendar;charset=utf8,' + encodeURIComponent(lines.join('\r\n'));
  }

  const entry = pickEventEntry();
  const next = entry?.next_occurrence || null;
  const startIso = next?.start || null;
  const endIso = next?.end || null;
  const startDate = startIso ? new Date(startIso) : null;
  const locationInfo = next?.location || {};
  const locationName = locationInfo.name || locationInfo.raw || '';
  const locationUrl = locationInfo.map_url || '';
  const displayTime = next?.display_time || '';
  const ticketLink = (entry?.ticket_link) || fallbackTicket;
  const scheduled = Boolean(startDate);

  // Elements
  const scHeading = document.getElementById('scheduleHeading');
  const scBlock   = document.getElementById('scheduleBlock');
  const scWhen    = document.getElementById('scWhen');
  const scWhere   = document.getElementById('scWhere');
  const scAdd     = document.getElementById('scAddCal');
  const scDir     = document.getElementById('scDir');
  const scBook    = document.getElementById('scBook');
  const fabBook   = document.getElementById('fabBook');
  const shareFab  = document.getElementById('shareFab');

  const M = {
    bar: document.getElementById('mobileInfoBar'),
    title: document.getElementById('microTitle'),
    line1: document.getElementById('microLine1'),
    line2: document.getElementById('microLine2'),
    line3: document.getElementById('microLine3'),
    L1: document.getElementById('microLeft1'),
    L2: document.getElementById('microLeft2'),
    L3: document.getElementById('microLeft3'),
    A1: document.getElementById('microAction1'),
    A2: document.getElementById('microAction2'),
    R0: document.getElementById('microRightTitle'),
    R1: document.getElementById('microRight1'),
    R2: document.getElementById('microRight2'),
    R3: document.getElementById('microRight3'),
  };

  function assignText(el, value){
    if (!el) return;
    const text = (value || '').trim();
    if (text){
      el.textContent = text;
      el.removeAttribute('hidden');
    } else {
      el.textContent = '';
      el.setAttribute('hidden','');
    }
  }

  function updateFabSpacing(){
    const docEl = document.documentElement;
    const bookVisible = fabBook && !fabBook.hasAttribute('hidden');
    let bookHeight = 0;
    if (bookVisible){
      const rect = fabBook.getBoundingClientRect();
      bookHeight = rect.height || fabBook.offsetHeight || 0;
      if (!bookHeight){ requestAnimationFrame(updateFabSpacing); return; }
    }

    let shareBottom = 12;
    if (shareFab){
      if (bookVisible){ shareBottom += Math.round(bookHeight + 8); }
      docEl.style.setProperty('--fab-share-bottom', shareBottom + 'px');
    }

    let pad = 16;
    if (bookVisible && window.innerWidth < 960){
      pad = Math.max(22, Math.round(bookHeight + 22));
    }
    docEl.style.setProperty('--mobile-bottom-pad', pad + 'px');
  }

  const microTitle = fallbackTitle || entry?.title || '';
  if (M.title) M.title.textContent = microTitle;

  if (scheduled && startDate){
    scHeading?.removeAttribute('hidden');
    if (scBlock) scBlock.hidden = false;
    if (scWhen) scWhen.textContent = fmtDateOnly(startDate);
    if (scWhere) scWhere.textContent = locationName || '';
    if (scAdd) scAdd.href = makeICS({ title: microTitle, start: startIso, end: endIso, locationText: locationName, locationUrl, description: location.href });
    if (scDir){
      if (locationUrl){ scDir.href = locationUrl; scDir.removeAttribute('hidden'); }
      else { scDir.removeAttribute('href'); scDir.setAttribute('hidden',''); }
    }
    if (ticketLink){
      if (scBook){ scBook.href = ticketLink; scBook.removeAttribute('hidden'); }
      if (fabBook){ fabBook.href = ticketLink; fabBook.removeAttribute('hidden'); }
    } else {
      scBook?.setAttribute('hidden','');
      fabBook?.setAttribute('hidden','');
    }

    const line1Text = displayTime ? `${fmtDateOnly(startDate)} | ${displayTime}` : fmtDateOnly(startDate);
    if (M.L1) M.L1.textContent = line1Text;
    M.line1?.removeAttribute('hidden');
    assignText(M.R1, '');

    if (M.L2) M.L2.textContent = locationName || '';
    if (locationName){ M.line2?.removeAttribute('hidden'); } else { M.line2?.setAttribute('hidden',''); }
    assignText(M.R2, '');

    if (M.A1){
      M.A1.textContent = 'Add to Calendar';
      M.A1.href = makeICS({ title: microTitle, start: startIso, end: endIso, locationText: locationName, locationUrl, description: location.href });
      M.A1.hidden = false;
    }

    if (M.A2){
      if (locationUrl){
        M.A2.textContent = 'Get Directions';
        M.A2.href = locationUrl;
        M.A2.hidden = false;
      } else {
        M.A2.hidden = true;
        M.A2.removeAttribute('href');
      }
    }

    if (M.L3) M.L3.textContent = '';
    assignText(M.R0, '');
    assignText(M.R3, '');
    M.line3?.setAttribute('hidden','');
  } else {
    scHeading?.setAttribute('hidden','');
    if (scBlock) scBlock.hidden = true;
    scBook?.setAttribute('hidden','');
    fabBook?.setAttribute('hidden','');

    assignText(M.R0, dGroup);
    const hasLine1 = Boolean((dFormat || '').trim() || (dDuration || '').trim());
    if (M.line1){
      if (hasLine1){ M.line1.removeAttribute('hidden'); }
      else { M.line1.setAttribute('hidden',''); }
    }
    if (M.L1) M.L1.textContent = dFormat;
    assignText(M.R1, dDuration);
    if (M.A1){ M.A1.hidden = true; M.A1.removeAttribute('href'); }

    const hasLine2 = Boolean((dDiff || '').trim() || (dPrice || '').trim());
    if (M.line2){
      if (hasLine2){ M.line2.removeAttribute('hidden'); }
      else { M.line2.setAttribute('hidden',''); }
    }
    if (M.L2) M.L2.textContent = dDiff;
    assignText(M.R2, dPrice);
    if (M.A2){ M.A2.hidden = true; M.A2.removeAttribute('href'); }

    if (M.L3){ M.L3.textContent = ''; }
    assignText(M.R3, '');
    M.line3?.setAttribute('hidden','');
  }

  updateFabSpacing();
  window.addEventListener('resize', updateFabSpacing);

  (function(){
    const microbar = M.bar;
    const banner = document.querySelector('.banner');
    if (!microbar || !banner) return;
    function isDesktop(){ return window.innerWidth >= 960; }
    function update(){
      if (isDesktop()){ microbar.classList.remove('show'); microbar.setAttribute('aria-hidden','true'); return; }
      const topbarH = (document.querySelector('.topbar')?.offsetHeight || 56);
      const rect = banner.getBoundingClientRect();
      const bottomY = rect.bottom + window.scrollY;
      const shouldShow = window.scrollY >= (bottomY - topbarH);
      microbar.classList.toggle('show', shouldShow);
      microbar.setAttribute('aria-hidden', shouldShow ? 'false' : 'true');
    }
    window.addEventListener('load', update, { passive:true });
    window.addEventListener('scroll', update, { passive:true });
    window.addEventListener('resize', update);
    window.__updateMicrobarVis = update;
  })();

  (function(){
    async function sharePage(){
      const data = { title: document.title, text: document.title, url: location.href };
      try{
        if (navigator.share) await navigator.share(data);
        else { await navigator.clipboard.writeText(data.url); alert('Link copied to clipboard'); }
      }catch(e){}
    }
    document.getElementById('shareBtnSide')?.addEventListener('click', sharePage);
    shareFab?.addEventListener('click', sharePage);
  })();
})();
</script>

{% include scripts-contact-phone.html %}

<!-- Video Lightbox -->
<script>
(function(){
  const modal  = document.getElementById('vidModal');
  const stage  = document.getElementById('vidStage');
  const frame  = document.getElementById('vidFrame');
  const close  = document.getElementById('vidClose');
  if (!modal || !frame || !stage) return;

  function openFrom(el){
    const url = el.getAttribute('data-embed') || el.querySelector('iframe')?.src || '';
    const withAuto = url + (url.includes('?') ? '&' : '?') + 'autoplay=1';
    if (el.classList.contains('video-portrait')) stage.classList.add('portrait'); else stage.classList.remove('portrait');
    frame.src = withAuto;
    modal.hidden = false;
  }
  function shut(){ frame.src = 'about:blank'; modal.hidden = true; }

  document.querySelectorAll('[data-embed], .video-portrait').forEach(v => {
    v.addEventListener('click', () => openFrom(v));
  });
  close.addEventListener('click', shut);
  modal.addEventListener('click', (e)=>{ if (e.target === modal) shut(); });
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !modal.hidden) shut(); });
})();
</script>
