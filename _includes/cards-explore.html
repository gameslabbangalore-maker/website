<div class="title" style="margin-top:40px;"><h2>Explore Our Other Events</h2></div>
<div id="explore-cards" class="cards-row"></div>
<script>
(function(){
  const EVENTS = [
  {% for event in site.events %}
    {% unless event.draft or event.published == false %}
    {
      slug: {{ event.data.slug | default: event.slug | jsonify }},
      title: {{ event.title | jsonify }},
      intro: {{ event.intro | default: event.tagline | default: '' | jsonify }},
      banner: {{ event.banner | default: event.hero_image | jsonify }},
      url: {{ event.url | relative_url | jsonify }},
      order: {{ event.card_order | default: event.order | default: forloop.index0 | jsonify }}
    }{% unless forloop.last %},{% endunless %}
    {% endunless %}
  {% endfor %}
  ].filter(Boolean);

  const container = document.getElementById('explore-cards');
  if (!container) return;

  const fallbackImage = "https://via.placeholder.com/800x450?text=Event+Image";
  const upcomingCsv = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSs9vlFaLhdFNFXvWsBIXlAJu0J5Dj2deY_7SlwAGd9Jk1-djK6xP3rdXim7Co0BJ-pUJueDCYYugew/pub?gid=1356004046&single=true&output=csv";

  if (!EVENTS.length){
    container.innerHTML = '<div style="color:#bbb;text-align:center;">No events have been published yet.</div>';
    return;
  }

  EVENTS.sort((a, b) => {
    const ao = typeof a.order === 'number' ? a.order : parseInt(a.order, 10);
    const bo = typeof b.order === 'number' ? b.order : parseInt(b.order, 10);
    if (!isNaN(ao) && !isNaN(bo) && ao !== bo) return ao - bo;
    return (a.title || '').localeCompare(b.title || '');
  });

  setSkeletons(container, Math.min(EVENTS.length, 3));

  function clean(value){
    if (value == null) return '';
    return String(value).trim().replace(/^"|"$/g,'');
  }

  function normalizeSlug(value){
    if (!value) return '';
    return value.toString().toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  }

  function slugFromUrl(url){
    if (!url) return '';
    const path = url.replace(/^https?:\/\/[^/]+/i,'').replace(/^\/+|\/+$/g,'');
    if (!path) return '';
    const segments = path.split('/');
    return normalizeSlug(segments[segments.length - 1] || '');
  }

  function withTransform(url){
    if (!url) return '';
    if (/\/tr:/.test(url) || /[?&]tr=/.test(url)) return url;
    if (url.includes('imagekit.io')){
      return url.replace(/(imagekit\.io\/[^/]+)/, '$1/tr:w-800,h-450,fo-auto');
    }
    return url + (url.includes('?') ? '&' : '?') + 'tr=w-800,h-450,fo-auto';
  }

  function renderCards(scheduledSet){
    const scheduled = scheduledSet || new Set();
    const visible = EVENTS.filter(evt => {
      const slug = normalizeSlug(evt.slug || evt.title);
      return slug && !scheduled.has(slug);
    });

    if (visible.length > 0){
      setSkeletons(container, visible.length);
    }

    visible.forEach((evt, idx) => {
      const card = document.createElement('div');
      card.className = 'card';

      const media = document.createElement('div');
      media.className = 'media';
      const img = document.createElement('img');
      const banner = evt.banner || '';
      img.src = banner ? withTransform(banner) : fallbackImage;
      img.alt = (evt.title || 'Event image');
      img.loading = 'lazy';
      img.width = 800; img.height = 450;
      img.onerror = function(){ this.onerror = null; this.src = fallbackImage; };
      media.appendChild(img);
      card.appendChild(media);

      const body = document.createElement('div');
      body.className = 'card-body';

      const title = document.createElement('div');
      title.className = 'event-title';
      title.textContent = evt.title || '';
      body.appendChild(title);

      if (evt.intro && String(evt.intro).trim() !== ''){
        const tagline = document.createElement('div');
        tagline.className = 'event-tagline';
        tagline.textContent = String(evt.intro).trim();
        body.appendChild(tagline);
      }

      card.appendChild(body);

      const footer = document.createElement('div');
      footer.className = 'card-footer';
      if (evt.url){
        const learn = document.createElement('a');
        learn.className = 'book-btn';
        learn.href = evt.url;
        learn.textContent = 'Learn More';
        learn.target = '_self';
        learn.removeAttribute('rel');
        footer.appendChild(learn);

        card.addEventListener('click', function(e){
          if (e.target.closest('a')) return;
          if (window.innerWidth <= 768) {
            window.location.href = learn.href;
          }
        });
      }
      card.appendChild(footer);

      replaceSkeletonWithCard(container, idx, card);
    });

    if (!visible.length){
      container.innerHTML = '<div style="color:#bbb;text-align:center;">No other events to explore at this time.</div>';
    }
  }

  fetch(upcomingCsv + '&cb=' + Date.now(), { cache: 'no-store' })
    .then(res => {
      if (!res.ok) throw new Error('Failed to load upcoming events CSV');
      return res.text();
    })
    .then(text => {
      const parsed = Papa.parse(text, { skipEmptyLines: true });
      const rows = parsed.data || [];
      if (!rows.length){
        renderCards(new Set());
        return;
      }
      const header = rows[0].map(h => clean(h).toLowerCase());
      const findIndex = (...candidates) => {
        for (let i = 0; i < header.length; i++){
          if (candidates.includes(header[i])) return i;
        }
        return -1;
      };
      const idxEvent = findIndex('event', 'event name', 'eventname');
      const idxLink = findIndex('page link', 'pagelink', 'page');
      const idxScheduled = findIndex('scheduled');

      const scheduled = new Set();
      for (let r = 1; r < rows.length; r++){
        const row = rows[r];
        if (!row) continue;
        if (idxScheduled !== -1){
          const flag = clean(row[idxScheduled]).toLowerCase();
          if (flag && flag !== 'yes') continue;
        }
        if (idxLink !== -1){
          const slug = slugFromUrl(clean(row[idxLink]));
          if (slug) scheduled.add(slug);
        }
        if (idxEvent !== -1){
          const nameSlug = normalizeSlug(clean(row[idxEvent]));
          if (nameSlug) scheduled.add(nameSlug);
        }
      }

      renderCards(scheduled);
    })
    .catch(err => {
      console.error('Error determining scheduled events:', err);
      renderCards(new Set());
    });
})();
</script>
