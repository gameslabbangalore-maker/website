<div class="title" style="margin-top:40px;"><h2>Explore Our Other Events</h2></div>
<div id="explore-cards" class="cards-row"></div>
<script>
(function(){
  const EVENTS = [
  {% for event in site.events %}
    {% unless event.draft or event.published == false %}
    {
      slug: {{ event.data.slug | default: event.slug | jsonify }},
      title: {{ event.title | jsonify }},
      intro: {{ event.intro | default: event.tagline | default: '' | jsonify }},
      banner: {{ event.banner | default: event.hero_image | jsonify }},
      url: {{ event.url | relative_url | jsonify }},
      order: {{ event.card_order | default: event.order | default: forloop.index0 | jsonify }}
    }{% unless forloop.last %},{% endunless %}
    {% endunless %}
  {% endfor %}
  ].filter(Boolean);

  const scheduledSlugs = new Set([
    {% assign scheduled = site.data.event_schedule.scheduled_slugs | default: empty %}
    {% for slug in scheduled %}
      {{ slug | jsonify }}{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ].filter(Boolean));

  const container = document.getElementById('explore-cards');
  if (!container) return;

  const fallbackImage = "https://via.placeholder.com/800x450?text=Event+Image";

  if (!EVENTS.length){
    container.innerHTML = '<div style="color:#bbb;text-align:center;">No events have been published yet.</div>';
    return;
  }

  EVENTS.sort((a, b) => {
    const ao = typeof a.order === 'number' ? a.order : parseInt(a.order, 10);
    const bo = typeof b.order === 'number' ? b.order : parseInt(b.order, 10);
    if (!isNaN(ao) && !isNaN(bo) && ao !== bo) return ao - bo;
    return (a.title || '').localeCompare(b.title || '');
  });

  function normalizeSlug(value){
    if (!value) return '';
    return value.toString().toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  }

  function withTransform(url){
    if (!url) return '';
    if (/\/tr:/.test(url) || /[?&]tr=/.test(url)) return url;
    if (url.includes('imagekit.io')){
      return url.replace(/(imagekit\.io\/[^/]+)/, '$1/tr:w-800,h-450,fo-auto');
    }
    return url + (url.includes('?') ? '&' : '?') + 'tr=w-800,h-450,fo-auto';
  }

  function renderCards(){
    const visible = EVENTS.filter(evt => {
      const slug = normalizeSlug(evt.slug || evt.title);
      return slug && !scheduledSlugs.has(slug);
    });

    if (!visible.length){
      container.innerHTML = '<div style="color:#bbb;text-align:center;">No other events to explore at this time.</div>';
      return;
    }

    setSkeletons(container, Math.min(visible.length, 3));

    visible.forEach((evt, idx) => {
      const card = document.createElement('div');
      card.className = 'card';

      const media = document.createElement('div');
      media.className = 'media';
      const img = document.createElement('img');
      const banner = evt.banner || '';
      img.src = banner ? withTransform(banner) : fallbackImage;
      img.alt = (evt.title || 'Event image');
      img.loading = 'lazy';
      img.width = 800; img.height = 450;
      img.onerror = function(){ this.onerror = null; this.src = fallbackImage; };
      media.appendChild(img);
      card.appendChild(media);

      const body = document.createElement('div');
      body.className = 'card-body';

      const title = document.createElement('div');
      title.className = 'event-title';
      title.textContent = evt.title || '';
      body.appendChild(title);

      if (evt.intro && String(evt.intro).trim() !== ''){
        const tagline = document.createElement('div');
        tagline.className = 'event-tagline';
        tagline.textContent = String(evt.intro).trim();
        body.appendChild(tagline);
      }

      card.appendChild(body);

      const footer = document.createElement('div');
      footer.className = 'card-footer';
      if (evt.url){
        const learn = document.createElement('a');
        learn.className = 'book-btn';
        learn.href = evt.url;
        learn.textContent = 'Learn More';
        learn.target = '_self';
        learn.removeAttribute('rel');
        footer.appendChild(learn);

        card.addEventListener('click', function(e){
          if (e.target.closest('a')) return;
          if (window.innerWidth <= 768) {
            window.location.href = learn.href;
          }
        });
      }
      card.appendChild(footer);

      replaceSkeletonWithCard(container, idx, card);
    });
  }

  renderCards();
})();
</script>
