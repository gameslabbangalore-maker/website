<div class="title" style="margin-top:40px;"><h2>Gallery</h2></div>

<div id="gallery" class="gallery-wrap">
  <button class="gal-nav gal-prev" aria-label="Previous image">&lsaquo;</button>
  <button class="gal-nav gal-next" aria-label="Next image">&rsaquo;</button>

  <div id="gallery-skeletons" class="gallery-skeletons">
    <div class="gal-skel"><div class="gal-skel-bg"></div></div>
    <div class="gal-skel"><div class="gal-skel-bg"></div></div>
    <div class="gal-skel"><div class="gal-skel-bg"></div></div>
    <div class="gal-skel"><div class="gal-skel-bg"></div></div>
    <div class="gal-skel"><div class="gal-skel-bg"></div></div>
    <div class="gal-skel"><div class="gal-skel-bg"></div></div>
  </div>

  <div class="gallery-viewport">
    <div class="gallery-track" id="gallery-track" aria-live="polite"></div>
  </div>
</div>

<div id="gal-lightbox" class="gal-lightbox" hidden>
  <div class="gal-lightbox-inner">
    <button class="gal-lightbox-close" aria-label="Close">&times;</button>
    <button class="gal-lightbox-prev" aria-label="Previous">&lsaquo;</button>
    <button class="gal-lightbox-next" aria-label="Next">&rsaquo;</button>
    <div class="gal-lightbox-stage">
      <img id="gal-lightbox-img" alt="">
      <div id="gal-lightbox-cap" class="gal-lightbox-cap"></div>
    </div>
  </div>
</div>

<script>
(function(){
  const RAW_ITEMS = {{ site.data.gallery | jsonify | replace: '</', '<\/' }};
  const MAX_SKELETONS = 6;

  const wrap  = document.getElementById('gallery');
  const track = document.getElementById('gallery-track');
  const skel  = document.getElementById('gallery-skeletons');
  if (!wrap || !track || !skel) return;

  const isMobile = () => window.innerWidth <= 768;
  const slidesPerView = () => 1;

  // ImageKit transform only if URL is ImageKit; otherwise return original
  function withIK(url, transform) {
    if (!/https?:\/\/[^/]*ik\.imagekit\.io\//i.test(url)) return url;
    try {
      const u = new URL(url);
      if (/\/tr:/.test(u.pathname)) {
        u.pathname = u.pathname.replace(/\/tr:([^/]+)/, (m, g1) => '/tr:' + (g1.includes('f-auto') ? g1 : g1 + ',f-auto'));
        return u.toString();
      }
      const parts = u.pathname.split('/');
      if (parts.length >= 3) {
        const t = (transform ? transform + ',' : '') + 'f-auto';
        parts.splice(2, 0, 'tr:' + t);
        u.pathname = parts.join('/');
        return u.toString();
      }
      return url;
    } catch(e) { return url; }
  }
  let items = [];
  let openLightbox = () => {};

  try {
    const rows = Array.isArray(RAW_ITEMS) ? RAW_ITEMS : [];
    items = rows
      .map((row, idx) => {
        const image = typeof row?.image === 'string' ? row.image.trim() : '';
        const alt = typeof row?.alt === 'string' ? row.alt.trim() : '';
        const caption = typeof row?.caption === 'string' ? row.caption.trim() : '';
        const showVal = row?.show;
        const orderRaw = row?.order;
        let show = true;
        if (typeof showVal === 'boolean') {
          show = showVal;
        } else {
          const str = String(showVal ?? 'yes').trim().toLowerCase();
          show = !['no','n','false','0'].includes(str);
        }
        let order = null;
        if (typeof orderRaw === 'number' && !Number.isNaN(orderRaw)) {
          order = orderRaw;
        } else if (typeof orderRaw === 'string' && orderRaw.trim() !== '') {
          const parsed = Number(orderRaw.trim());
          if (!Number.isNaN(parsed)) order = parsed;
        }
        return { idx, image, alt, caption, show, order };
      })
      .filter(item => item.image && item.show)
      .sort((a, b) => {
        if (a.order != null && b.order != null) return a.order - b.order;
        if (a.order != null) return -1;
        if (b.order != null) return 1;
        return a.idx - b.idx;
      });

    if (!items.length) {
      skel.innerHTML = '<div style="color:#bbb;text-align:center;padding:16px 0">No gallery images yet. Add entries to _data/gallery.yml.</div>';
      return;
    }

    items.forEach((item, index) => { item.idx = index; });

    function createSlide(obj){
      const slide = document.createElement('div');
      slide.className = 'gal-slide';

      const bg = document.createElement('div');
      bg.className = 'gal-bg';
      bg.style.backgroundImage = `url("${withIK(obj.image, 'w-40,q-10,bl-6')}")`;
      slide.appendChild(bg);

      const img = document.createElement('img');
      img.className = 'gal-img';
      img.alt = obj.alt || '';
      img.loading = 'lazy';
      img.decoding = 'async';
      const tr = isMobile() ? 'w-720,q-80' : 'w-1200,q-80';
      img.src = withIK(obj.image, tr);
      img.onerror = function(){
        if (!img.dataset.retry && /ik\.imagekit\.io/.test(obj.image)) {
          img.dataset.retry = '1';
          img.src = withIK(obj.image, tr.replace('f-auto','f-jpg'));
        }
      };
      img.addEventListener('load', ()=>{
        if (img.naturalHeight > img.naturalWidth) slide.classList.add('portrait');
      }, { once:true });

      slide.addEventListener('click', () => openLightbox(obj.idx));
      slide.appendChild(img);
      return slide;
    }

    while (skel.children.length > Math.min(items.length, MAX_SKELETONS)) {
      skel.removeChild(skel.lastElementChild);
    }

    let pos = 0, spv = slidesPerView(), sliding = false;

    function buildTrack(){
      spv = slidesPerView();
      track.innerHTML = '';

      const head = [], tail = [];
      for (let i=0;i<spv;i++){
        const hc = createSlide(items[i]); head.push(hc);
        const idx = items.length - spv + i;
        const tc = createSlide(items[idx]); tail.push(tc);
      }
      track.append(...tail);
      items.forEach(it => track.appendChild(createSlide(it)));
      track.append(...head);

      pos = spv;
      setTransform(false);
      skel.style.display = 'none';
    }

    function setTransform(animate=true){
      const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      track.style.transition = (animate && !reduce) ? 'transform .35s ease' : 'none';
      track.style.transform  = `translate3d(-${pos*(100/spv)}%,0,0)`;
    }

    function go(delta){
      if (sliding) return;
      sliding = true;
      pos += delta;
      setTransform(true);
      setTimeout(()=>{
        const total = items.length;
        if (pos < spv) { pos += total; setTransform(false); }
        else if (pos > total + spv - 1) { pos -= total; setTransform(false); }
        sliding = false;
      }, 380);
    }

    buildTrack();

    wrap.querySelector('.gal-prev').addEventListener('click', ()=>go(-1));
    wrap.querySelector('.gal-next').addEventListener('click', ()=>go(1));

    const viewport = wrap.querySelector('.gallery-viewport');
    let startX=0, startPos=pos, dragging=false;

    const W = () => viewport.clientWidth;
    function onDown(e){
      dragging = true;
      track.style.transition = 'none';
      startX = (e.touches ? e.touches[0].clientX : e.clientX);
      startPos = pos;
      pauseAuto();
    }
    function onMove(e){
      if (!dragging) return;
      const x  = (e.touches ? e.touches[0].clientX : e.clientX);
      const dx = x - startX;
      const pct = dx / W() * 100;
      track.style.transform = `translate3d(-${startPos*(100/spv) - pct}%,0,0)`;
    }
    function onUp(e){
      if (!dragging) return;
      dragging = false;
      const x  = (e.changedTouches ? e.changedTouches[0].clientX : e.clientX);
      const dx = x - startX;
      const threshold = Math.max(40, (W()/slidesPerView())*0.2);
      if (dx > threshold) go(-1);
      else if (dx < -threshold) go(1);
      else setTransform(true);
      resumeAutoSoon();
    }

    viewport.addEventListener('mousedown', onDown);
    viewport.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onUp);
    viewport.addEventListener('touchstart', onDown, { passive:true });
    viewport.addEventListener('touchmove', onMove, { passive:true });
    viewport.addEventListener('touchend', onUp);

    const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    let timer = null, paused = false;
    function tick(){ if (!paused) go(1); }
    function startAuto(){ if (!reduce && !timer) timer = setInterval(tick, 3500); }
    function stopAuto(){ if (timer){ clearInterval(timer); timer = null; } }
    function pauseAuto(){ paused = true; stopAuto(); }
    function resumeAuto(){ paused = false; startAuto(); }
    function resumeAutoSoon(){ setTimeout(()=>!dragging && resumeAuto(), 1200); }

    startAuto();
    viewport.addEventListener('mouseenter', pauseAuto);
    viewport.addEventListener('mouseleave', resumeAuto);
    viewport.addEventListener('touchstart', pauseAuto, {passive:true});
    viewport.addEventListener('touchend', resumeAutoSoon);

    const lb     = document.getElementById('gal-lightbox');
    const lbImg  = document.getElementById('gal-lightbox-img');
    const lbCap  = document.getElementById('gal-lightbox-cap');
    const lbClose= lb.querySelector('.gal-lightbox-close');
    const lbPrev = lb.querySelector('.gal-lightbox-prev');
    const lbNext = lb.querySelector('.gal-lightbox-next');

    let current = 0;
    openLightbox = function(realIdx){
      current = realIdx % items.length;
      updateLightbox();
      lb.hidden = false;
      pauseAuto();
    };
    function closeLightbox(){ lb.hidden = true; resumeAutoSoon(); }
    function updateLightbox(){
      const it = items[current];
      const src = /ik\.imagekit\.io/.test(it.image) ? withIK(it.image, 'w-1600,q-80') : it.image;
      lbImg.src = src;
      lbImg.alt = it.alt || '';
      lbCap.textContent = it.caption || '';
      lbCap.style.display = it.caption ? 'block' : 'none';
    }
    function lbGo(d){ current = (current + d + items.length) % items.length; updateLightbox(); }
    lbClose.addEventListener('click', closeLightbox);
    lbPrev .addEventListener('click', ()=>lbGo(-1));
    lbNext .addEventListener('click', ()=>lbGo(1));
    lb.addEventListener('click', (e)=>{ if (e.target === lb) closeLightbox(); });

    let lStart=0, lDrag=false;
    lb.addEventListener('touchstart', e=>{ lDrag=true; lStart=e.touches[0].clientX; }, {passive:true});
    lb.addEventListener('touchend', e=>{
      if(!lDrag) return; lDrag=false;
      const dx = e.changedTouches[0].clientX - lStart;
      const thr = 50;
      if (dx > thr) lbGo(-1);
      else if (dx < -thr) lbGo(1);
    });

    let lastSPV = slidesPerView();
    window.addEventListener('resize', ()=>{
      const now = slidesPerView();
      if (now !== lastSPV){
        lastSPV = now;
        buildTrack();
      }
    });
  } catch (err) {
    console.error('Gallery load error:', err);
    skel.innerHTML = '<div style="color:#f66;text-align:center;padding:16px 0">Could not load gallery.</div>';
  }
})();
</script>
