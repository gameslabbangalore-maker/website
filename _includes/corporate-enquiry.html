<section class="corporate-enquiry" aria-labelledby="corporate-enquiry-heading">
  <div class="corporate-enquiry__inner">
    <p id="corporate-enquiry-heading" class="corporate-enquiry__copy">
      We organize corporate, team-building, and private events — to create yours…
    </p>
    <button type="button" class="book-btn corporate-enquiry__trigger" data-modal-target="corporate-enquiry-modal">
      Enquire Now
    </button>
  </div>
</section>

<div class="corporate-modal" id="corporate-enquiry-modal" role="dialog" aria-modal="true" aria-labelledby="corporate-modal-title" hidden>
  <div class="corporate-modal__backdrop" data-modal-close></div>
  <div class="corporate-modal__dialog" role="document">
    <button type="button" class="corporate-modal__close" aria-label="Close enquiry form" data-modal-close>
      ×
    </button>
    <div class="corporate-modal__content">
      <h2 id="corporate-modal-title">Plan Your Event with Games Lab</h2>
      <form class="corporate-form" novalidate>
        <div class="corporate-form__grid">
          <label class="corporate-form__field">
            <span class="corporate-form__label">Name *</span>
            <input type="text" name="name" data-zoho-field="Name" autocomplete="name" required />
          </label>
          <label class="corporate-form__field">
            <span class="corporate-form__label">Company / Organization Name</span>
            <input type="text" name="company" data-zoho-field="CompanyOrganizationName" autocomplete="organization" />
          </label>
          <label class="corporate-form__field">
            <span class="corporate-form__label">Event Type *</span>
            <select name="eventType" data-zoho-field="EventType" required>
              <option value="" disabled selected>Select an option</option>
              <option>Corporate Event</option>
              <option>Team-Building Event</option>
              <option>Private Celebration</option>
              <option>Other</option>
            </select>
          </label>
          <label class="corporate-form__field">
            <span class="corporate-form__label">Contact Number *</span>
            <input type="tel" name="contact" data-zoho-field="ContactNumber" autocomplete="tel" required />
          </label>
          <label class="corporate-form__field">
            <span class="corporate-form__label">Email Address *</span>
            <input type="email" name="email" data-zoho-field="EmailAddress" autocomplete="email" required />
          </label>
          <label class="corporate-form__field">
            <span class="corporate-form__label">Preferred Date &amp; Time</span>
            <input type="datetime-local" name="datetime" data-zoho-field="PreferredDateTime" />
          </label>
          <label class="corporate-form__field">
            <span class="corporate-form__label">Preferred Location (area / cafe / space)</span>
            <input type="text" name="location" data-zoho-field="PreferredLocation" />
          </label>
          <label class="corporate-form__field">
            <span class="corporate-form__label">Group Size</span>
            <input type="number" name="groupSize" data-zoho-field="GroupSize" min="1" />
          </label>
          <label class="corporate-form__field corporate-form__field--full">
            <span class="corporate-form__label">What are you looking for?</span>
            <textarea name="details" data-zoho-field="WhatAreYouLookingFor" rows="3"></textarea>
          </label>
          <label class="corporate-form__field corporate-form__field--full">
            <span class="corporate-form__label">How did you hear about us?</span>
            <input type="text" name="referral" data-zoho-field="HowDidYouHearAboutUs" />
          </label>
        </div>
        <div class="corporate-form__actions">
          <button type="submit" class="book-btn">Submit Enquiry</button>
        </div>
        <p class="corporate-form__error" role="alert" hidden>Please fill in all required fields.</p>
      </form>
      <div class="corporate-form__success" role="status" hidden>
        <p>Thank you for enquiring with Games Lab. We will get back to you within 24 hours with next steps, ideas, and availability.</p>
      </div>
    </div>
  </div>
</div>

<form
  id="corporate-zoho-proxy"
  class="corporate-zoho-proxy"
  action="https://forms.zohopublic.in/infogame1/form/CorporateEventEnquiry/formperma/U6qIOzComB_KEFFu44Sy3mp57NtCr0-1qvUt-kVjCrI/submit"
  method="POST"
  target="corporate-zoho-target"
  accept-charset="UTF-8"
  hidden
  aria-hidden="true"
></form>
<iframe
  name="corporate-zoho-target"
  id="corporate-zoho-target"
  title="Corporate enquiry submission"
  hidden
  aria-hidden="true"
></iframe>

<script>
(function(){
  const modal = document.getElementById('corporate-enquiry-modal');
  if (!modal) return;

  const form = modal.querySelector('.corporate-form');
  const success = modal.querySelector('.corporate-form__success');
  const error = modal.querySelector('.corporate-form__error');
  const content = modal.querySelector('.corporate-modal__content');
  const detailsField = form ? form.querySelector('textarea[name="details"]') : null;
  const submitButton = form ? form.querySelector('button[type="submit"]') : null;
  const zohoForm = document.getElementById('corporate-zoho-proxy');
  const zohoTarget = document.getElementById('corporate-zoho-target');
  const zohoFields = form ? Array.from(form.querySelectorAll('[data-zoho-field]')) : [];
  const triggers = document.querySelectorAll('[data-modal-target="corporate-enquiry-modal"]');
  const closeButtons = modal.querySelectorAll('[data-modal-close]');
  let lastFocused = null;
  let iframeInitialized = false;
  let submissionPending = false;
  const defaultSubmitText = submitButton ? submitButton.textContent : '';
  const defaultErrorText = error ? error.textContent : '';

  function openModal(){
    if (!modal.hasAttribute('hidden')) return;
    lastFocused = document.activeElement;
    modal.removeAttribute('hidden');
    document.body.classList.add('corporate-modal-open');
    const firstInput = modal.querySelector('input, select, textarea, button');
    window.setTimeout(() => {
      (firstInput || modal).focus({ preventScroll: true });
      adjustTextareaHeight();
    }, 10);
    modal.addEventListener('keydown', handleKeydown);
    window.addEventListener('resize', handleResize);
  }

  function closeModal(){
    if (modal.hasAttribute('hidden')) return;
    modal.setAttribute('hidden', '');
    document.body.classList.remove('corporate-modal-open');
    modal.removeEventListener('keydown', handleKeydown);
    window.removeEventListener('resize', handleResize);
    if (lastFocused && typeof lastFocused.focus === 'function'){
      lastFocused.focus({ preventScroll: true });
    }
    resetForm();
  }

  function handleKeydown(event){
    if (event.key === 'Escape'){
      event.preventDefault();
      closeModal();
    } else if (event.key === 'Tab'){
      trapFocus(event);
    }
  }

  function trapFocus(event){
    const focusable = Array.from(modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))
      .filter(el => !el.hasAttribute('hidden') && !el.closest('[hidden]') && !el.disabled);
    if (!focusable.length) return;
    const first = focusable[0];
    const last = focusable[focusable.length - 1];
    if (event.shiftKey && document.activeElement === first){
      event.preventDefault();
      last.focus();
    } else if (!event.shiftKey && document.activeElement === last){
      event.preventDefault();
      first.focus();
    }
  }

  function adjustTextareaHeight(){
    if (!detailsField || !content) return;
    detailsField.style.height = '';
    if (!window.matchMedia('(min-width: 769px)').matches){
      content.style.overflow = 'auto';
      return;
    }

    requestAnimationFrame(() => {
      const overflow = content.scrollHeight - content.clientHeight;
      if (overflow > 0){
        const currentHeight = detailsField.offsetHeight;
        const targetHeight = Math.max(72, currentHeight - overflow - 12);
        if (targetHeight < currentHeight){
          detailsField.style.height = `${targetHeight}px`;
        }
      }
      const remainingOverflow = content.scrollHeight - content.clientHeight;
      content.style.overflow = remainingOverflow > 0 ? 'auto' : 'visible';
    });
  }

  function handleResize(){
    if (!modal.hasAttribute('hidden')){
      adjustTextareaHeight();
    }
  }

  function resetForm(){
    if (!form) return;
    form.reset();
    if (error) error.setAttribute('hidden', '');
    if (success) success.setAttribute('hidden', '');
    if (error && defaultErrorText) error.textContent = defaultErrorText;
    form.removeAttribute('hidden');
    setSubmitting(false);
    submissionPending = false;
    if (detailsField){
      detailsField.style.height = '';
    }
    if (content){
      content.style.overflow = 'auto';
    }
  }

  function getValue(name){
    const field = form.elements[name];
    if (!field) return '';
    if (field instanceof RadioNodeList){
      return field.value.trim();
    }
    return (field.value || '').trim();
  }

  triggers.forEach(btn => {
    btn.addEventListener('click', openModal);
  });

  closeButtons.forEach(btn => {
    btn.addEventListener('click', closeModal);
  });

  modal.addEventListener('click', function(event){
    if (event.target.classList.contains('corporate-modal__backdrop')){
      closeModal();
    }
  });

  if (form){
    form.addEventListener('submit', function(event){
      event.preventDefault();
      if (!form.checkValidity()){
        if (error) error.removeAttribute('hidden');
        form.reportValidity();
        return;
      }
      if (error){
        error.textContent = defaultErrorText;
        error.setAttribute('hidden', '');
      }
      if (!zohoForm || !zohoTarget){
        if (error){
          error.textContent = 'We could not connect to the enquiry service. Please try again later or reach us at corporate@gameslab.co.in.';
          error.removeAttribute('hidden');
        }
        return;
      }

      while (zohoForm.firstChild){
        zohoForm.removeChild(zohoForm.firstChild);
      }

      const hiddenFields = {
        zf_referrer_name: document.title || 'Games Lab Corporate Enquiry',
        zf_redirect_url: '',
        zf_source: window.location.href
      };

      Object.keys(hiddenFields).forEach(key => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = hiddenFields[key];
        zohoForm.appendChild(input);
      });

      zohoFields.forEach(field => {
        const zohoName = field.getAttribute('data-zoho-field');
        if (!zohoName) return;
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = zohoName;
        input.value = getValue(field.name) || '';
        zohoForm.appendChild(input);
      });

      submissionPending = true;
      setSubmitting(true);
      zohoForm.submit();
    });
  }

  if (zohoTarget){
    zohoTarget.addEventListener('load', function(){
      if (!iframeInitialized){
        iframeInitialized = true;
        return;
      }
      if (!submissionPending) return;
      submissionPending = false;
      if (form) form.setAttribute('hidden', '');
      if (success) success.removeAttribute('hidden');
      setSubmitting(false);
      adjustTextareaHeight();
    });
  }

  function setSubmitting(state){
    if (!submitButton) return;
    submitButton.disabled = state;
    submitButton.classList.toggle('is-loading', state);
    submitButton.textContent = state ? 'Submitting…' : defaultSubmitText;
  }
})();
</script>
