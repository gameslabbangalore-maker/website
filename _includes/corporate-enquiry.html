<section class="corporate-enquiry" aria-labelledby="corporate-enquiry-heading">
  <div class="corporate-enquiry__inner">
    <p id="corporate-enquiry-heading" class="corporate-enquiry__copy">
      We organize corporate, team-building, and private events — to create yours…
    </p>
    <button type="button" class="book-btn corporate-enquiry__trigger" data-modal-target="corporate-enquiry-modal">
      Enquire Now
    </button>
  </div>
</section>

<div class="corporate-modal" id="corporate-enquiry-modal" role="dialog" aria-modal="true" aria-labelledby="corporate-modal-title" hidden>
  <div class="corporate-modal__backdrop" data-modal-close></div>
  <div class="corporate-modal__dialog" role="document">
    <button type="button" class="corporate-modal__close" aria-label="Close enquiry form" data-modal-close>
      ×
    </button>
    <div class="corporate-modal__content">
      <div class="corporate-modal__header">
        <h2 id="corporate-modal-title">Plan Your Event with Games Lab</h2>
      </div>
      <div class="corporate-modal__body">
        <div class="corporate-modal__frame">
          <iframe
            title="Corporate Event Enquiry"
            loading="lazy"
            frameborder="0"
            allowtransparency="true"
            allow="geolocation"
            data-src-primary="https://forms.zohopublic.com/infogame1/form/CorporateEventEnquiry/formperma/U6qIOzComB_KEFFu44Sy3mp57NtCr0-1qvUt-kVjCrI/formEmbed?zf_rszfm=1"
            data-src-fallback="https://forms.zohopublic.in/infogame1/form/CorporateEventEnquiry/formperma/U6qIOzComB_KEFFu44Sy3mp57NtCr0-1qvUt-kVjCrI/formEmbed?zf_rszfm=1"
          ></iframe>
        </div>
        <div class="corporate-modal__fallback" hidden>
          <p>We couldn’t load the enquiry form in this window.</p>
          <button type="button" class="book-btn corporate-modal__fallback-btn" data-modal-open-tab>
            Open form in a new tab
          </button>
        </div>
        <p class="corporate-modal__note">
          Having trouble? <a class="corporate-modal__note-link" href="https://forms.zohopublic.in/infogame1/form/CorporateEventEnquiry/formperma/U6qIOzComB_KEFFu44Sy3mp57NtCr0-1qvUt-kVjCrI" target="_blank" rel="noopener">Open the form in a new tab</a>.
        </p>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('corporate-enquiry-modal');
  if (!modal) return;

  const html = document.documentElement;
  const content = modal.querySelector('.corporate-modal__body');
  const frame = modal.querySelector('iframe');
  const fallbackBlock = modal.querySelector('.corporate-modal__fallback');
  const fallbackButton = modal.querySelector('[data-modal-open-tab]');
  const directLink = modal.querySelector('.corporate-modal__note-link');
  const triggers = document.querySelectorAll('[data-modal-target="corporate-enquiry-modal"]');
  const closeButtons = modal.querySelectorAll('[data-modal-close]');
  let lastFocused = null;
  let scrollPosition = 0;
  let frameLoaded = false;
  let loadTimer = null;

  function openModal(){
    if (!modal.hasAttribute('hidden')) return;
    lastFocused = document.activeElement;
    scrollPosition = window.pageYOffset || document.documentElement.scrollTop || 0;
    modal.removeAttribute('hidden');
    html.classList.add('corporate-modal-open');
    document.body.classList.add('corporate-modal-open');
    document.body.style.top = `-${scrollPosition}px`;
    if (content){
      content.scrollTop = 0;
    }
    if (fallbackBlock){
      fallbackBlock.hidden = true;
    }
    if (frame && !frameLoaded){
      startFrameLoad();
    }
    window.setTimeout(() => {
      const firstInput = modal.querySelector('iframe, button, [href], input, select, textarea');
      (firstInput || modal).focus({ preventScroll: true });
    }, 10);
    modal.addEventListener('keydown', handleKeydown);
  }

  function closeModal(){
    if (modal.hasAttribute('hidden')) return;
    modal.setAttribute('hidden', '');
    html.classList.remove('corporate-modal-open');
    document.body.classList.remove('corporate-modal-open');
    document.body.style.removeProperty('top');
    modal.removeEventListener('keydown', handleKeydown);
    window.scrollTo(0, scrollPosition);
    cancelFrameTimer();
    if (lastFocused && typeof lastFocused.focus === 'function'){
      lastFocused.focus({ preventScroll: true });
    }
  }

  function handleKeydown(event){
    if (event.key === 'Escape'){
      event.preventDefault();
      closeModal();
    } else if (event.key === 'Tab'){
      trapFocus(event);
    }
  }

  function trapFocus(event){
    const focusable = Array.from(modal.querySelectorAll('button, [href], input, select, textarea, iframe, [tabindex]:not([tabindex="-1"])'))
      .filter(el => !el.hasAttribute('hidden') && !el.closest('[hidden]') && !el.disabled);
    if (!focusable.length) return;
    const first = focusable[0];
    const last = focusable[focusable.length - 1];
    if (event.shiftKey && document.activeElement === first){
      event.preventDefault();
      last.focus();
    } else if (!event.shiftKey && document.activeElement === last){
      event.preventDefault();
      first.focus();
    }
  }

  function startFrameLoad(){
    if (!frame) return;
    const primary = frame.getAttribute('data-src-primary');
    const fallback = frame.getAttribute('data-src-fallback');
    const sources = [primary, fallback].filter(Boolean);
    let currentIndex = -1;

    function tryNext(){
      currentIndex += 1;
      if (currentIndex >= sources.length){
        showFallback();
        return;
      }
      if (frame.getAttribute('src') === sources[currentIndex]){
        scheduleFallback(tryNext);
        return;
      }
      frame.removeAttribute('hidden');
      frame.setAttribute('src', sources[currentIndex]);
      scheduleFallback(tryNext);
    }

    frame.addEventListener('load', () => {
      frameLoaded = true;
      cancelFrameTimer();
      if (fallbackBlock){
        fallbackBlock.hidden = true;
      }
    }, { once: true });

    tryNext();
  }

  function scheduleFallback(callback){
    cancelFrameTimer();
    loadTimer = window.setTimeout(() => {
      if (!frameLoaded){
        callback();
      }
    }, 3500);
  }

  function cancelFrameTimer(){
    if (loadTimer){
      window.clearTimeout(loadTimer);
      loadTimer = null;
    }
  }

  function showFallback(){
    cancelFrameTimer();
    if (frame){
      frame.removeAttribute('src');
      frame.setAttribute('hidden', '');
    }
    if (fallbackBlock){
      fallbackBlock.hidden = false;
    }
  }

  if (fallbackButton && directLink){
    fallbackButton.addEventListener('click', () => {
      window.open(directLink.href, '_blank', 'noopener');
    });
  }

  triggers.forEach(button => {
    button.addEventListener('click', openModal);
  });

  closeButtons.forEach(button => {
    button.addEventListener('click', closeModal);
  });

  modal.addEventListener('click', event => {
    if (event.target && event.target.hasAttribute('data-modal-close')){
      closeModal();
    }
  });
})();
</script>
