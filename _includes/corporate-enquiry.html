<section class="corporate-enquiry" aria-labelledby="corporate-enquiry-heading">
  <div class="corporate-enquiry__inner">
    <p id="corporate-enquiry-heading" class="corporate-enquiry__copy">
      We organize corporate, team-building, and private events — to create yours…
    </p>
    <button type="button" class="book-btn corporate-enquiry__trigger" data-modal-target="corporate-enquiry-modal">
      Enquire Now
    </button>
  </div>
</section>

<div class="corporate-modal" id="corporate-enquiry-modal" role="dialog" aria-modal="true" aria-labelledby="corporate-modal-title" hidden>
  <div class="corporate-modal__backdrop" data-modal-close></div>
  <div class="corporate-modal__dialog" role="document">
    <button type="button" class="corporate-modal__close" aria-label="Close enquiry form" data-modal-close>
      ×
    </button>
    <div class="corporate-modal__content">
      <div class="corporate-modal__header">
        <h2 id="corporate-modal-title">Plan Your Event with Games Lab</h2>
      </div>
      <div class="corporate-modal__body">
        <form
          class="corporate-form"
          novalidate
          data-zoho-endpoint="https://forms.zohopublic.in/infogame1/form/CorporateEventEnquiry/formperma/U6qIOzComB_KEFFu44Sy3mp57NtCr0-1qvUt-kVjCrI/submit"
          data-zoho-token="U6qIOzComB_KEFFu44Sy3mp57NtCr0-1qvUt-kVjCrI"
        >
          <div class="corporate-form__grid">
            <label class="corporate-form__field">
              <span class="corporate-form__label">Name *</span>
              <input type="text" name="name" data-zoho-field="Name" autocomplete="name" required />
            </label>
            <label class="corporate-form__field">
              <span class="corporate-form__label">Company / Organization Name</span>
              <input type="text" name="company" data-zoho-field="CompanyOrganizationName" autocomplete="organization" />
            </label>
            <label class="corporate-form__field">
              <span class="corporate-form__label">Event Type *</span>
              <select name="eventType" data-zoho-field="EventType" required>
                <option value="" disabled selected>Select an option</option>
                <option>Corporate Event</option>
                <option>Team-Building Event</option>
                <option>Private Celebration</option>
                <option>Other</option>
              </select>
            </label>
            <label class="corporate-form__field">
              <span class="corporate-form__label">Contact Number *</span>
              <input type="tel" name="contact" data-zoho-field="ContactNumber" autocomplete="tel" required />
            </label>
            <label class="corporate-form__field">
              <span class="corporate-form__label">Email Address *</span>
              <input type="email" name="email" data-zoho-field="EmailAddress" autocomplete="email" required />
            </label>
            <label class="corporate-form__field">
              <span class="corporate-form__label">Preferred Date &amp; Time</span>
              <input type="datetime-local" name="datetime" data-zoho-field="PreferredDateTime" />
            </label>
            <label class="corporate-form__field">
              <span class="corporate-form__label">Preferred Location (area / cafe / space)</span>
              <input type="text" name="location" data-zoho-field="PreferredLocation" />
            </label>
            <label class="corporate-form__field">
              <span class="corporate-form__label">Group Size</span>
              <input type="number" name="groupSize" data-zoho-field="GroupSize" min="1" />
            </label>
            <label class="corporate-form__field corporate-form__field--full">
              <span class="corporate-form__label">What are you looking for?</span>
              <textarea name="details" data-zoho-field="WhatAreYouLookingFor" rows="3"></textarea>
            </label>
            <label class="corporate-form__field corporate-form__field--full">
              <span class="corporate-form__label">How did you hear about us?</span>
              <input type="text" name="referral" data-zoho-field="HowDidYouHearAboutUs" />
            </label>
          </div>
          <div class="corporate-form__actions">
            <button type="submit" class="book-btn">Submit Enquiry</button>
          </div>
          <p class="corporate-form__error" role="alert" hidden>Please fill in all required fields.</p>
        </form>
        <div class="corporate-form__success" role="status" hidden>
          <p>Thank you for enquiring with Games Lab. We will get back to you within 24 hours with next steps, ideas, and availability.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<form
  id="corporate-zoho-proxy"
  class="corporate-zoho-proxy"
  action="https://forms.zohopublic.in/infogame1/form/CorporateEventEnquiry/formperma/U6qIOzComB_KEFFu44Sy3mp57NtCr0-1qvUt-kVjCrI/submit"
  method="POST"
  target="corporate-zoho-target"
  accept-charset="UTF-8"
  hidden
  aria-hidden="true"
></form>
<iframe
  name="corporate-zoho-target"
  id="corporate-zoho-target"
  title="Corporate enquiry submission"
  hidden
  aria-hidden="true"
></iframe>

<script>
(function(){
  const modal = document.getElementById('corporate-enquiry-modal');
  if (!modal) return;

  const html = document.documentElement;
  const form = modal.querySelector('.corporate-form');
  const success = modal.querySelector('.corporate-form__success');
  const error = modal.querySelector('.corporate-form__error');
  const content = modal.querySelector('.corporate-modal__body');
  const detailsField = form ? form.querySelector('textarea[name="details"]') : null;
  const submitButton = form ? form.querySelector('button[type="submit"]') : null;
  const zohoForm = document.getElementById('corporate-zoho-proxy');
  const zohoTarget = document.getElementById('corporate-zoho-target');
  const zohoFields = form ? Array.from(form.querySelectorAll('[data-zoho-field]')) : [];
  const endpoint = form ? form.getAttribute('data-zoho-endpoint') : '';
  const zohoToken = form ? form.getAttribute('data-zoho-token') : '';
  const triggers = document.querySelectorAll('[data-modal-target="corporate-enquiry-modal"]');
  const closeButtons = modal.querySelectorAll('[data-modal-close]');
  let lastFocused = null;
  let submissionPending = false;
  let fetchController = null;
  let fetchTimeout = null;
  let fallbackTimer = null;
  let scrollPosition = 0;
  const defaultSubmitText = submitButton ? submitButton.textContent : '';
  const defaultErrorText = error ? error.textContent : '';

  function openModal(){
    if (!modal.hasAttribute('hidden')) return;
    lastFocused = document.activeElement;
    scrollPosition = window.pageYOffset || document.documentElement.scrollTop || 0;
    modal.removeAttribute('hidden');
    html.classList.add('corporate-modal-open');
    document.body.classList.add('corporate-modal-open');
    document.body.style.top = `-${scrollPosition}px`;
    if (content){
      content.scrollTop = 0;
    }
    const firstInput = modal.querySelector('input, select, textarea, button');
    window.setTimeout(() => {
      (firstInput || modal).focus({ preventScroll: true });
      adjustTextareaHeight();
    }, 10);
    modal.addEventListener('keydown', handleKeydown);
    window.addEventListener('resize', handleResize);
  }

  function closeModal(){
    if (modal.hasAttribute('hidden')) return;
    modal.setAttribute('hidden', '');
    html.classList.remove('corporate-modal-open');
    document.body.classList.remove('corporate-modal-open');
    document.body.style.removeProperty('top');
    modal.removeEventListener('keydown', handleKeydown);
    window.removeEventListener('resize', handleResize);
    window.scrollTo(0, scrollPosition);
    if (lastFocused && typeof lastFocused.focus === 'function'){
      lastFocused.focus({ preventScroll: true });
    }
    resetForm();
  }

  function handleKeydown(event){
    if (event.key === 'Escape'){
      event.preventDefault();
      closeModal();
    } else if (event.key === 'Tab'){
      trapFocus(event);
    }
  }

  function trapFocus(event){
    const focusable = Array.from(modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))
      .filter(el => !el.hasAttribute('hidden') && !el.closest('[hidden]') && !el.disabled);
    if (!focusable.length) return;
    const first = focusable[0];
    const last = focusable[focusable.length - 1];
    if (event.shiftKey && document.activeElement === first){
      event.preventDefault();
      last.focus();
    } else if (!event.shiftKey && document.activeElement === last){
      event.preventDefault();
      first.focus();
    }
  }

  function adjustTextareaHeight(){
    if (!detailsField || !content) return;
    detailsField.style.height = '';
    if (!window.matchMedia('(min-width: 769px)').matches){
      content.style.overflow = 'auto';
      return;
    }

    requestAnimationFrame(() => {
      const overflow = content.scrollHeight - content.clientHeight;
      if (overflow > 0){
        const currentHeight = detailsField.offsetHeight;
        const targetHeight = Math.max(72, currentHeight - overflow - 12);
        if (targetHeight < currentHeight){
          detailsField.style.height = `${targetHeight}px`;
        }
      }
      const remainingOverflow = content.scrollHeight - content.clientHeight;
      content.style.overflow = remainingOverflow > 0 ? 'auto' : 'visible';
    });
  }

  function handleResize(){
    if (!modal.hasAttribute('hidden')){
      adjustTextareaHeight();
    }
  }

  function resetForm(){
    if (!form) return;
    if (fetchController){
      try { fetchController.abort(); } catch (err) {}
      fetchController = null;
    }
    if (fetchTimeout){
      window.clearTimeout(fetchTimeout);
      fetchTimeout = null;
    }
    clearFallbackWatch();
    form.reset();
    if (error){
      error.textContent = defaultErrorText;
      error.setAttribute('hidden', '');
    }
    if (success) success.setAttribute('hidden', '');
    form.removeAttribute('hidden');
    setSubmitting(false);
    submissionPending = false;
    if (detailsField){
      detailsField.style.height = '';
    }
    if (content){
      content.scrollTop = 0;
      content.style.overflow = 'auto';
    }
  }

  function buildEntries(){
    const entries = [];
    const hiddenFields = {
      zf_referrer_name: document.title || 'Games Lab Corporate Enquiry',
      zf_redirect_url: '',
      zf_source: window.location.href
    };
    if (zohoToken){
      hiddenFields.zf_token = zohoToken;
      hiddenFields.formLinkId = zohoToken;
    }
    Object.keys(hiddenFields).forEach(key => {
      entries.push([key, hiddenFields[key] || '']);
    });
    zohoFields.forEach(field => {
      const zohoName = field.getAttribute('data-zoho-field');
      if (!zohoName) return;
      entries.push([zohoName, getFieldValue(field)]);
    });
    return entries;
  }

  function getFieldValue(field){
    if (!field) return '';
    if (field.type === 'checkbox'){
      return field.checked ? (field.value || 'on').trim() : '';
    }
    if (field.type === 'select-multiple'){
      return Array.from(field.selectedOptions || [])
        .map(option => (option.value || '').trim())
        .filter(Boolean)
        .join(', ');
    }
    return (field.value || '').trim();
  }

  function postToZoho(entries){
    if (!window.fetch || !endpoint){
      return Promise.reject(new Error('unavailable'));
    }
    const payload = new URLSearchParams();
    entries.forEach(([key, value]) => {
      payload.append(key, value);
    });
    const controller = 'AbortController' in window ? new AbortController() : null;
    const options = { method: 'POST', body: payload, mode: 'no-cors' };
    if (controller){
      options.signal = controller.signal;
      fetchController = controller;
      fetchTimeout = window.setTimeout(() => {
        fetchTimeout = null;
        try { controller.abort(); } catch (err) {}
      }, 15000);
    }
    return fetch(endpoint, options).finally(() => {
      if (fetchTimeout){
        window.clearTimeout(fetchTimeout);
        fetchTimeout = null;
      }
      fetchController = null;
    });
  }

  function submitViaProxy(entries){
    if (!zohoForm || !zohoTarget) return false;
    while (zohoForm.firstChild){
      zohoForm.removeChild(zohoForm.firstChild);
    }
    entries.forEach(([key, value]) => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = key;
      input.value = value;
      zohoForm.appendChild(input);
    });
    startFallbackWatch();
    zohoForm.submit();
    return true;
  }

  function showSuccess(){
    clearFallbackWatch();
    submissionPending = false;
    if (form) form.setAttribute('hidden', '');
    if (success) success.removeAttribute('hidden');
    setSubmitting(false);
    adjustTextareaHeight();
  }

  function showError(message){
    clearFallbackWatch();
    submissionPending = false;
    setSubmitting(false);
    if (error){
      error.textContent = message || defaultErrorText;
      error.removeAttribute('hidden');
    }
  }

  function setSubmitting(state){
    if (!submitButton) return;
    submitButton.disabled = state;
    submitButton.classList.toggle('is-loading', state);
    submitButton.textContent = state ? 'Submitting…' : defaultSubmitText;
  }

  function startFallbackWatch(){
    clearFallbackWatch();
    fallbackTimer = window.setTimeout(() => {
      if (!submissionPending) return;
      showSuccess();
    }, 8000);
  }

  function clearFallbackWatch(){
    if (fallbackTimer){
      window.clearTimeout(fallbackTimer);
      fallbackTimer = null;
    }
  }

  triggers.forEach(btn => {
    btn.addEventListener('click', openModal);
  });

  closeButtons.forEach(btn => {
    btn.addEventListener('click', closeModal);
  });

  modal.addEventListener('click', event => {
    if (event.target.classList.contains('corporate-modal__backdrop')){
      closeModal();
    }
  });

  if (form){
    form.addEventListener('submit', event => {
      event.preventDefault();
      if (!form.checkValidity()){
        if (error) error.removeAttribute('hidden');
        form.reportValidity();
        return;
      }
      if (error){
        error.textContent = defaultErrorText;
        error.setAttribute('hidden', '');
      }

      const entries = buildEntries();
      submissionPending = true;
      setSubmitting(true);

      postToZoho(entries)
        .then(() => {
          showSuccess();
        })
        .catch(() => {
          if (!submissionPending) return;
          const fallbackWorked = submitViaProxy(entries);
          if (!fallbackWorked){
            showError('We could not connect to the enquiry service. Please try again later or reach us at corporate@gameslab.co.in.');
          }
        });
    });
  }

  if (zohoTarget){
    zohoTarget.addEventListener('load', () => {
      if (!submissionPending) return;
      showSuccess();
    });
  }
})();
</script>
